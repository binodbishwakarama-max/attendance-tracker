<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Attendance Tracker</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2EC4B6">
    <meta name="description"
        content="Track and manage student attendance with ease. Export to PDF, Excel, and share on WhatsApp.">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Attendance">
    <link rel="apple-touch-icon" href="icons/icon-152.png">

    <!-- Windows/MS Tile -->
    <meta name="msapplication-TileImage" content="icons/icon-144.png">
    <meta name="msapplication-TileColor" content="#004E89">

    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-blue: #004E89;
            --primary-yellow: #F7B32B;
            --primary-teal: #2EC4B6;
            --bg-gradient: linear-gradient(135deg, #004E89 0%, #2EC4B6 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-dark: #1F2937;
            --text-light: #F9FAFB;
            --text-muted: #6B7280;
            --card-bg: white;
            --header-bg: rgba(255, 255, 255, 0.95);
            --search-bg: white;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #111827 0%, #1F2937 100%);
            --glass-bg: rgba(31, 41, 55, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-dark: #F9FAFB;
            --text-muted: #9CA3AF;
            --card-bg: #374151;
            --header-bg: rgba(17, 24, 39, 0.95);
            --search-bg: #374151;
        }

        /* Battery Saver */
        body.battery-saver * {
            animation: none !important;
            transition: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
        }

        .pinned-icon {
            color: var(--primary-yellow);
            margin-right: 5px;
            display: none;
        }

        .student-card.pinned .pinned-icon {
            display: inline-block;
        }

        .floating-bubble {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--primary-orange);
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.2s;
            animation: bounceIn 0.5s;
        }

        .floating-bubble:active {
            transform: scale(0.95);
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            80% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .settings-menu {
            position: absolute;
            top: 60px;
            right: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            padding: 10px;
            display: none;
            z-index: 2000;
            width: 200px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            color: var(--text-dark);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .settings-item:hover {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-blue);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* Strength Indicator */
        .strength-indicator {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: -5px;
            margin-bottom: 5px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'DM Sans', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        /* Layout Container */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
            position: relative;
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* Typography */
        h1,
        h2,
        h3 {
            font-family: 'Archivo Black', sans-serif;
            letter-spacing: -0.5px;
        }

        /* Welcome Screen */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: white;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .welcome-title {
            font-size: 3.5rem;
            line-height: 1;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .date-pill {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 40px;
            backdrop-filter: blur(5px);
        }

        .subject-input {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-family: 'DM Sans', sans-serif;
            outline: none;
        }

        .start-btn {
            background: linear-gradient(135deg, #FF6B35, #F7B32B);
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            color: white;
            font-size: 1.5rem;
            font-family: 'Archivo Black', sans-serif;
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            animation: pulse 3s infinite;
            text-transform: uppercase;
        }

        .start-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            animation: none;
            filter: grayscale(0.5);
        }

        .start-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(255, 107, 53, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0);
            }
        }

        /* Main Interface */
        #app-interface {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Sticky Header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--header-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            transition: background 0.3s;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            position: relative;
        }

        .icon-btn {
            background: var(--card-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-dark);
            transition: background 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        /* History View */
        #history-view {
            display: none;
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            height: calc(100vh - 70px);
            background: #F9FAFB;
            z-index: 1500;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-blue);
        }

        .h-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .h-subject {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .h-date {
            font-weight: 700;
            color: var(--text-dark);
        }

        .h-stats {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .h-actions {
            display: flex;
            gap: 10px;
        }

        .h-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: var(--card-bg);
            color: var(--text-dark);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .h-btn.primary {
            background: var(--primary-blue);
            color: white;
            border: none;
        }

        /* Replay Banner */
        #history-banner {
            display: none;
            background: var(--primary-yellow);
            color: black;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            position: sticky;
            top: 71px;
            z-index: 950;
        }

        /* Stats Grid */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            padding: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 12px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            animation: slideUp 0.5s ease backwards;
        }

        .stat-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .stat-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .stat-value {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.5rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 700;
            margin-top: 5px;
        }

        /* SVG Ring */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Sticky Controls */
        .sticky-controls {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: inherit;
            padding: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .search-bar {
            background: var(--search-bg);
            border-radius: 50px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            transition: all 0.3s;
            margin-bottom: 15px;
            /* Added spacing for toggle */
        }

        .search-bar:focus-within {
            border-color: var(--primary-blue);
            box-shadow: 0 5px 20px rgba(0, 78, 137, 0.2);
        }

        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            margin-left: 10px;
            font-size: 1rem;
            color: var(--text-dark);
        }

        /* NEW: View Mode Toggle */
        .view-toggle-container {
            display: flex;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            padding: 5px;
            border-radius: 50px;
            max-width: 300px;
            margin: 0 auto;
            border: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 115px;
            z-index: 1002;
        }

        .view-pill {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .view-pill.active {
            background: white;
            color: var(--primary-blue);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .view-pill.active-absent {
            background: white;
            color: var(--primary-orange);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .students-container {
            height: calc(100vh - 250px);
            overflow-y: auto;
        }

        /* Student List */
        .student-list {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s, opacity 0.3s;
            animation: fadeIn 0.4s ease-out backwards;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }

        .student-card.hidden {
            display: none !important;
        }

        .student-card.present {
            border-color: var(--primary-teal);
            background: linear-gradient(to right, rgba(46, 196, 182, 0.03), var(--card-bg) 30%);
        }

        .student-card.absent {
            border-color: var(--primary-orange);
            background: linear-gradient(to right, rgba(255, 107, 53, 0.03), var(--card-bg) 30%);
        }

        .student-card:active {
            transform: scale(0.98);
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #4B5563;
            margin-right: 12px;
            font-size: 1.1rem;
            flex-shrink: 0;
            position: relative;
        }

        .roll-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: var(--text-dark);
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        .student-info {
            flex: 1;
            overflow: hidden;
        }

        .student-name {
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-dark);
        }

        .student-usn {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle Pills */
        .status-toggle {
            display: flex;
            background: #F3F4F6;
            border-radius: 10px;
            padding: 3px;
            margin-left: 10px;
        }

        .toggle-btn {
            width: 40px;
            height: 36px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            background: transparent;
            color: #9CA3AF;
        }

        .toggle-btn.active.present-btn {
            background: var(--primary-teal);
            color: white;
            box-shadow: 0 2px 4px rgba(46, 196, 182, 0.3);
        }

        .toggle-btn.active.absent-btn {
            background: var(--primary-orange);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 107, 53, 0.3);
        }

        /* Export Card */
        .export-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin: 30px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .export-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 0.9rem;
        }

        .export-btn:active {
            transform: scale(0.96);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #004E89, #2EC4B6);
        }

        .btn-text {
            background: linear-gradient(135deg, #FF6B35, #F7B32B);
        }

        /* Mobile responsive for export buttons */
        @media (max-width: 600px) {
            .export-buttons div {
                flex-wrap: wrap;
                gap: 8px;
            }
            .export-btn {
                flex: none;
                min-width: 100px;
                padding: 12px;
                font-size: 0.8rem;
            }
        }

        /* Sticky Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            z-index: 1000;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.05);
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 14px;
            border: none;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: opacity 0.2s;
        }

        .action-btn:active {
            opacity: 0.8;
        }

        .btn-mark-all-p {
            background: var(--primary-teal);
        }

        .btn-mark-all-a {
            background: var(--primary-orange);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1F2937;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Restore Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: bounceIn 0.3s;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .modal-text {
            color: var(--text-muted);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-restore {
            background: var(--primary-blue);
            color: white;
        }

        .btn-discard {
            background: #E5E7EB;
            color: #4B5563;
        }

        .auto-save-indicator {
            font-size: 0.7rem;
            color: var(--primary-teal);
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Summary Screen */
        #summary-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 4000;
            padding: 20px;
            overflow-y: auto;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.5s;
        }

        .summary-card-container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .summary-highlight {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .summary-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .summary-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 25px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-stat-box {
            background: #F3F4F6;
            border-radius: 12px;
            padding: 15px;
        }

        .summary-stat-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .summary-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .top-absentee-card {
            background: #FFF1F2;
            border: 1px solid #FFE4E6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: left;
        }

        .ta-header {
            font-size: 0.8rem;
            color: #BE123C;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .ta-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #881337;
        }

        .ta-details {
            font-size: 0.9rem;
            color: #9F1239;
        }

        .summary-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Frequent Absentee & UX Styles */
        .student-card.frequent-absent {
            border: 2px solid #F59E0B !important;
        }

        .warn-icon {
            display: none;
            color: #F59E0B;
            margin-right: 8px;
            font-size: 1.2rem;
            animation: pulseWarning 2s infinite;
        }

        .student-card.frequent-absent .warn-icon {
            display: block;
        }

        @keyframes pulseWarning {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shaking {
            animation: shake 0.3s ease-in-out;
            background: rgba(255, 0, 0, 0.1) !important;
        }

        .btn-summary {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s;
        }

        .btn-summary:active {
            transform: scale(0.98);
        }

        .btn-s-pdf {
            background: var(--primary-blue);
            color: white;
        }

        .btn-s-excel {
            background: #10B981;
            color: white;
        }

        .btn-s-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-s-insights {
            background: var(--card-bg);
            color: var(--text-dark);
            border: 1px solid #E5E7EB;
        }

        .strength-indicator {
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 15px 0;
            padding: 8px;
            background: rgba(0, 78, 137, 0.05);
            /* Subtle blue tint */
            border-radius: 8px;
        }

        /* Manage Modal Styles */
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .manage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        .manage-item button {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-s-home {
            background: transparent;
            color: var(--text-muted);
            border: 2px solid #E5E7EB;
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }
    </style>
</head>

<body>

    <div id="toast" class="toast">
        <span>‚úÖ Action Successful</span>
    </div>

    <!-- Restore Draft Modal -->
    <div id="restore-modal" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üíæ</div>
            <div class="modal-title">Unsaved Draft Found</div>
            <div class="modal-text">You have an unsaved attendance session from <span id="draft-time"></span>. Do you
                want to restore it?</div>
            <div class="modal-actions">
                <button class="btn-modal btn-discard" onclick="discardDraft()">Discard</button>
                <button class="btn-modal btn-restore" onclick="restoreDraft()">Restore</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay" onclick="if(event.target === this) toggleAbout()">
        <div class="modal-card" style="text-align: left; max-width: 400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title" style="margin:0;">About App</h3>
                <button onclick="toggleAbout()"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>

            <div class="modal-text" style="color:var(--text-dark); line-height: 1.6;">
                <p style="margin-bottom:15px;"><strong>Class Attendance Tracker</strong> is a modern offline-first
                    system designed for fast classroom usage.</p>

                <h4 style="margin-bottom:8px; display:flex; align-items:center; gap:5px;">üöÄ Key Features</h4>
                <ul style="font-size:0.9rem; margin-bottom:20px; padding-left:20px; color:var(--text-muted);">
                    <li>Mobile-first design</li>
                    <li>Subject-based attendance</li>
                    <li>PDF + Excel + WhatsApp Integration</li>
                    <li>Attendance History & Analytics</li>
                    <li>Smart 'Frequent Absentee' detection</li>
                    <li>Draft Auto-save & Restore</li>
                    <li>Offline-first capability</li>
                    <li>Dark Mode & Battery Saver</li>
                    <li>Smooth animations & sticky controls</li>
                </ul>

                <h4 style="margin-bottom:8px; display:flex; align-items:center; gap:5px;">üìã What's New in v1.1.0</h4>
                <ul style="font-size:0.9rem; margin-bottom:20px; padding-left:20px; color:var(--text-muted);">
                    <li>Added smooth fade-in animations for student cards</li>
                    <li>Sticky search bar and filter tabs for better scrolling</li>
                    <li>Mobile-responsive export buttons</li>
                    <li>Enhanced PWA features (reverted for stability)</li>
                </ul>

                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

                <div style="text-align:center; font-size:0.85rem; color:var(--text-muted);">
                    Built with ‚ù§Ô∏è by <br>
                    <strong>Binod Bishwakarma</strong>
                    <div style="margin-top:4px; font-size:0.75rem;">Version v1.1.0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="date-pill" id="welcome-date">Jan 01, 2024</div>
        <h1 class="welcome-title">Class<br>Attendance</h1>
        <p class="welcome-subtitle">Fast ‚Ä¢ Simple ‚Ä¢ Paperless</p>

        <!-- Subject Input -->
        <!-- Subject Input -->
        <select id="subject-input" class="subject-input" onchange="checkSubject()"
            style="background: white; text-align-last: center;">
            <option value="" disabled selected>Select Subject</option>
            <!-- Generated Dynamically -->
        </select>

        <button id="start-btn" class="start-btn" onclick="startApp()">Start</button>
    </div>

    <!-- Main App Container -->
    <div class="app-container">

        <!-- Sticky Header (Tabbed) -->
        <header class="sticky-header"
            style="justify-content: space-between; padding: 10px 15px; background: rgba(255, 255, 255, 0.95);">
            <div style="display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; align-items: center;">
                <div id="app-date"
                    style="padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; background: #F3F4F6; color: #666; white-space: nowrap;">
                    TODAY</div>
                <div id="app-subject-title"
                    style="padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; background: #004E89; color: white; white-space: nowrap; box-shadow: 0 4px 10px rgba(0, 78, 137, 0.2);">
                    SUBJECT</div>
                <span id="auto-save-msg" class="auto-save-indicator">Saved</span>
            </div>
            <div class="header-actions">
                <div id="pwa-install-btn" class="icon-btn" onclick="installPWA()" title="Install App"
                    style="display: none; background: var(--primary-teal); color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </div>
                <div class="icon-btn" onclick="toggleAbout()" title="About">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </div>
                <div class="icon-btn" onclick="toggleHistory()" title="History">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </div>
                <div class="icon-btn" onclick="toggleSettings()" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </div>
            </div>

            <!-- Settings Menu -->
            <div id="settings-menu" class="settings-menu">
                <div class="settings-item" onclick="openManageModal()">
                    <span>‚öô Manage Class</span>
                </div>
                <div class="settings-item">
                    <span>Dark Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Battery Saver</span>
                    <label class="switch">
                        <input type="checkbox" id="battery-saver-toggle" onchange="toggleBatterySaver()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item" onclick="undoLastAction()">
                    <span>‚Ü© Undo Last Action</span>
                </div>
                <div class="settings-item" onclick="resetApp()">
                    <span style="color:var(--primary-orange);">‚ö° Reset Session</span>
                </div>
                <div class="settings-item" onclick="backupData()">
                    <span>üíæ Backup Data</span>
                </div>
                <div class="settings-item" onclick="triggerRestore()">
                    <span>üìÇ Restore Data</span>
                </div>
                <div class="settings-item" onclick="clearHistory()">
                    <span style="color:red;">üóë Clear History</span>
                </div>
                <input type="file" id="restore-input" style="display: none;" onchange="restoreData(this)">
            </div>
        </header>

        <!-- History View -->
        <div id="history-view">
            <div class="history-header">
                <h3>üìö Attendance History</h3>
                <button class="h-btn" onclick="toggleHistory()">Close ‚úï</button>
            </div>
            <div id="history-list">
                <!-- Records injected here -->
            </div>
            <button class="h-btn" style="width: 100%; margin-top: 20px; color: red; border-color: red;"
                onclick="clearHistory()">Clear History</button>
        </div>

        <!-- History Banner (visible only when viewing old record) -->
        <div id="history-banner">
            Viewing Saved Record ‚Ä¢ <span style="text-decoration: underline; cursor: pointer;"
                onclick="exitHistoryMode()">Return to Live</span>
        </div>

        <!-- Main Content -->
        <div id="app-interface">

            <!-- Stats Grid -->
            <section class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--primary-teal)">‚úî</div>
                    <div class="stat-value" id="count-present" style="color: var(--primary-teal)">0</div>
                    <div class="stat-label">Present</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--primary-orange)">‚úñ</div>
                    <div class="stat-value" id="count-absent" style="color: var(--primary-orange)">0</div>
                    <div class="stat-label">Absent</div>
                </div>
                <div class="stat-card" style="padding: 5px;">
                    <div
                        style="position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="26" stroke="#E5E7EB" stroke-width="6" fill="none" />
                            <circle id="progress-ring" class="progress-ring__circle" cx="30" cy="30" r="26"
                                stroke="#004E89" stroke-width="6" fill="none" stroke-linecap="round"
                                stroke-dasharray="163" stroke-dashoffset="0" />
                        </svg>
                        <span id="stats-percentage"
                            style="position: absolute; font-size: 0.8rem; font-weight: 700; color: #004E89;">0%</span>
                    </div>
                </div>
            </section>
            <div id="class-strength" class="strength-indicator">Total Class Strength: 0</div>

            <div class="sticky-controls">
                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="search-input" placeholder="Search name, roll, or USN..." onkeyup="filterStudents()">
                </div>
                <div class="view-toggle-container">
                    <div id="pill-all" class="view-pill active" onclick="setFilterMode('all')">Show All</div>
                    <div id="pill-absent" class="view-pill" onclick="setFilterMode('absent')">Only Absent</div>
                </div>
            </div>

            <div class="students-container">
                <div id="students-container" class="student-list">
                    <!-- Data injection here -->
                </div>
            </div>

            <!-- Export Card -->
            <div class="export-card">
                <div class="export-title">Export Options</div>
                <div class="export-buttons">
                    <div style="display: flex; gap: 10px;">
                        <button class="export-btn" style="background: #1F2937;" onclick="generateAbsenteePDF()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            Absentee
                        </button>
                        <button class="export-btn" style="background: #4B5563;" onclick="generateFullPDF()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <path d="M17 21v-2a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Full List
                        </button>
                        <button class="export-btn" style="background: #10B981;" onclick="generateExcel()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="8" y1="13" x2="16" y2="13"></line>
                                <line x1="8" y1="17" x2="16" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                            Excel
                        </button>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="export-btn btn-text" onclick="copyTextReport()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy Text
                        </button>
                        <button class="export-btn" style="background: #25D366;" onclick="shareToWhatsApp()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                                </path>
                            </svg>
                            WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer
            style="text-align: center; padding: 40px 20px; color: var(--text-dark); margin-top: auto; opacity: 0.8;">
            <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">Built by Binod Bishwakarma</div>
            <div style="font-size: 0.85rem; font-weight: 500; opacity: 0.9;">Version v1.1.0</div>
        </footer>
    </div>

    <div class="bottom-bar">
        <button class="action-btn btn-mark-all-p" onclick="markAll(true)">Mark All Present</button>
        <button class="action-btn btn-mark-all-a" onclick="markAll(false)">Mark All Absent</button>
    </div>

    <div id="floating-bubble" class="floating-bubble" style="display:none;" onclick="setFilterMode('absent')">
        <span>0</span> Absentees
    </div>

    <!-- Summary Screen -->
    <div id="summary-screen">
        <!-- Confetti Container -->
        <div id="confetti-container"
            style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:4100;">
        </div>

        <div class="summary-card-container">
            <div class="summary-highlight" id="summary-icon">‚úÖ</div>
            <h2 class="summary-title" id="summary-subject">Subject Name</h2>
            <p class="summary-subtitle" id="summary-date">Jan 01, 2024</p>

            <div class="summary-grid">
                <div class="summary-stat-box">
                    <div class="summary-stat-val" style="color:var(--primary-teal)" id="sum-present">0</div>
                    <div class="summary-stat-label">Present</div>
                </div>
                <div class="summary-stat-box">
                    <div class="summary-stat-val" style="color:var(--primary-orange)" id="sum-absent">0</div>
                    <div class="summary-stat-label">Absent</div>
                </div>
                <div class="summary-stat-box" style="grid-column: span 2;">
                    <div class="summary-stat-val" style="color:var(--primary-blue)" id="sum-percentage">0%</div>
                    <div class="summary-stat-label">Attendance Rate</div>
                </div>
            </div>

            <div class="top-absentee-card">
                <div class="ta-header">‚ö†Ô∏è Top Absentee (All Time)</div>
                <div id="ta-content">
                    <div class="ta-name" id="ta-name">Loading...</div>
                    <div class="ta-details" id="ta-desc">USN: ... ‚Ä¢ Total Absences: ...</div>
                </div>
            </div>

            <div class="summary-actions">
                <button class="btn-summary btn-s-pdf" onclick="generateAbsenteePDF(null, null, null, true)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    Download PDF Again
                </button>
                <button class="btn-summary btn-s-whatsapp" onclick="shareToWhatsApp()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg>
                    Share on WhatsApp
                </button>
                <button class="btn-summary btn-s-insights"
                    onclick="toggleHistory(); document.getElementById('summary-screen').style.display='none';">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18" />
                        <path d="M18 17l-6-6-6 6" />
                        <path d="M12 11l6-6" />
                    </svg>
                    View History Insights
                </button>
                <button class="btn-summary btn-s-home" onclick="goHome()">
                    üè† Back Home
                </button>
            </div>
        </div>
    </div>

    </div>

    <script>
        // Default Data for Reset/Init
        const defaultStudentList = [
            { roll: 1, name: "ANSH KATIYAR", usn: "ENG25CS0399" },
            { roll: 2, name: "ANSHI DEEP SINHA", usn: "ENG25DS0082" },
            { roll: 3, name: "ANSHUMAN KUMAR", usn: "ENG25CS0400" },
            { roll: 4, name: "ANTARIKSH BORAH", usn: "ENG25AM0222" },
            { roll: 5, name: "ANUSHKA MISHRA", usn: "ENG25CS0407" },
            { roll: 6, name: "ANUSHKA SRIVASTAVA", usn: "ENG25CS0408" },
            { roll: 7, name: "ARGHITH JAIN PAMRITHRAJ", usn: "ENG25AM0224" },
            { roll: 8, name: "ARITRAA DAS", usn: "ENG25AM0226" },
            { roll: 9, name: "ARJUN HANVI", usn: "ENG25AM0227" },
            { roll: 10, name: "ARJUN P", usn: "ENG25CS0413" },
            { roll: 11, name: "ARKA DAS", usn: "ENG25CY0082" },
            { roll: 12, name: "ARMAN KUMAR", usn: "ENG25AM0228" },
            { roll: 13, name: "ARNAV CHOUDHARY", usn: "ENG25CS0414" },
            { roll: 14, name: "ARPIT KIRAN", usn: "Unknown" },
            { roll: 15, name: "ARUNKUMAR PATIL", usn: "ENG25CS0417" },
            { roll: 16, name: "ARYAN ANAND", usn: "ENG25CS0420" },
            { roll: 17, name: "ARYAN BHARDWAJ", usn: "ENG25AM0229" },
            { roll: 18, name: "ARYAN MADHOK", usn: "Unknown" },
            { roll: 19, name: "ASHISH UPADHYAY", usn: "ENG25AM0231" },
            { roll: 20, name: "ASHIT KIRAN REDDY", usn: "ENG25AM0232" },
            { roll: 21, name: "ASHITH PRAJWAL", usn: "ENG25CS0422" },
            { roll: 22, name: "ASHITOSH SHARMA", usn: "ENG25CS0423" },
            { roll: 23, name: "AYUSH MODI", usn: "ENG25CY0085" },
            { roll: 24, name: "AYUSH RAJ", usn: "ENG25CS0431" },
            { roll: 25, name: "AYUSH RAJ", usn: "ENG25CY0086" },
            { roll: 26, name: "AYUSH SAO", usn: "ENG25AM0235" },
            { roll: 27, name: "CHETAN REDDY", usn: "ENG25AM0237" },
            { roll: 28, name: "B DAMARA REDDY", usn: "" },
            { roll: 29, name: "B HARSHAVARDHAN", usn: "ENG25CS0433" },
            { roll: 30, name: "B MITHRAN REDDY", usn: "ENG25AM0239" },
            { roll: 31, name: "B ROHAN POWLEY", usn: "" },
            { roll: 32, name: "BARANIDHARAN K", usn: "ENG25CS0440" },
            { roll: 33, name: "BESTHA DHARANEESH BALAJI", usn: "ENG25CS0442" },
            { roll: 34, name: "BHANU PRAKASH PENAMALE VENKATARANGA R", usn: "ENG25CS0443" },
            { roll: 35, name: "BHAVYA", usn: "ENG25CS0445" },
            { roll: 36, name: "BHAVYA", usn: "ENG25CS0446" },
            { roll: 37, name: "BHUMA PRANEETH REDDY", usn: "ENG25CS0648" },
            { roll: 38, name: "BHUVAN K Y", usn: "ENG25RA0058" },
            { roll: 39, name: "BINDUSARA GOWDA G S", usn: "ENG25CS0452" },
            { roll: 40, name: "BINDYA P", usn: "ENG25DS0086" },
            { roll: 41, name: "BINOD BISHWAKARAMA", usn: "ENG25CS0453" },
            { roll: 42, name: "BOJJA JITHI", usn: "ENG25CS0455" },
            { roll: 43, name: "BOMMANA NITHISH REDDY", usn: "ENG25CS0456" },
            { roll: 44, name: "BONALA ABHINAV KUMAR REDDY", usn: "ENG25AM0248" },
            { roll: 45, name: "BONTHA ASRITH REDDY", usn: "ENG25AM0249" },
            { roll: 46, name: "C DHANUSH", usn: "ENG25CY0090" },
            { roll: 47, name: "C M HALEEMA SADIYA", usn: "ENG25AM0250" },
            { roll: 48, name: "C SHREEJAN", usn: "ENG25AM0251" },
            { roll: 49, name: "CHADALAVADA MANVIT", usn: "ENG25CS0460" },
            { roll: 50, name: "CHADIVE KARTHIKEYA REDDY", usn: "ENG25CS0461" },
            { roll: 51, name: "CHAKRALA NAVYA", usn: "ENG25CS0462" },
            { roll: 52, name: "CHALLA VENKATA SAI KOTI REDDY", usn: "ENG25RA0059" },
            { roll: 53, name: "CHANDAN K S", usn: "ENG25AM0252" },
            { roll: 54, name: "CHANDHAN REDDY J B", usn: "ENG25AM0254" },
            { roll: 55, name: "CHARAN M REDDY", usn: "ENG25AM0255" },
            { roll: 56, name: "CHEKKA YASHWANTH", usn: "ENG25AM0258" },
            { roll: 57, name: "D REKHA SHRI", usn: "" },
            { roll: 58, name: "D THANUJ", usn: "ENG25AD0103" },
            { roll: 59, name: "DAKSH SHAH", usn: "ENG25CS0472" },
            { roll: 60, name: "DANDU MOHAN CHAITHANYA", usn: "ENG25CS0473" },
            { roll: 61, name: "DANIYA FATIMA", usn: "ENG25CS0474" },
            { roll: 62, name: "DARSHAN KALAL", usn: "ENG25AM0263" },
            { roll: 63, name: "DEBADRITA PANDA", usn: "ENG25DS0092" },
            { roll: 64, name: "DEENATHAYALAN", usn: "ENG25AD0106" },
            { roll: 65, name: "DEEPAK SHANMUGAM", usn: "ENG25CS0479" },
            { roll: 66, name: "DEVANGA PUNITH SAI KUMAR", usn: "ENG25AM0267" },
            { roll: 67, name: "DEVESH AGRE", usn: "ENG25CS0481" },
            { roll: 68, name: "DHRUV SHARMA", usn: "ENG25AM0273" },
            { roll: 69, name: "DIYA MEENAKSHI J", usn: "ENG25DS0095" },
            { roll: 70, name: "S ROHIL", usn: "ENG25CS0998" }
        ];

        let students = [];
        let viewHistoryMode = false;
        let currentRecordDate = null;
        let currentSubject = "";
        let currentFilter = "all"; // all | absent
        let actionStack = []; // For Undo
        let autoSaveInterval = null;

        // UX State
        let frequentAbsentees = new Set();
        let pressTimer = null;
        let audioCtx = null;

        const studentContainer = document.getElementById('students-container');
        const countPresentEl = document.getElementById('count-present');
        const countAbsentEl = document.getElementById('count-absent');
        const percentageEl = document.getElementById('stats-percentage');
        const ringEl = document.getElementById('progress-ring');

        const subjectInput = document.getElementById('subject-input');
        const strengthEl = document.getElementById('class-strength');
        const bubbleEl = document.getElementById('floating-bubble');
        const circumference = 163;

        let classConfig = { students: [], subjects: [] };

        function initApp() {
            // Restore Settings
            if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();
            if (localStorage.getItem('batterySaver') === 'true') toggleBatterySaver();

            initClassConfig();
            initData();
            initDates();
            renderStudents();
            updateStats();

            // Check for drafts
            checkForDrafts();
            calculateFrequentAbsentees();
        }

        function initClassConfig() {
            const savedConfig = localStorage.getItem('classConfig');
            if (savedConfig) {
                classConfig = JSON.parse(savedConfig);
            } else {
                // Default Initialization
                classConfig.subjects = [
                    "Physics", "Maths", "Electrical Engineering", "Biology",
                    "Sustainable Engineering", "C Programming", "Constitution And Law"
                ];
                // rawStudentData is below, defined as default const
                classConfig.students = defaultStudentList;
                saveConfig();
            }
            renderSubjectsDropdown();
        }

        function renderSubjectsDropdown() {
            const select = document.getElementById('subject-input');
            select.innerHTML = '<option value="" disabled selected>Select Subject</option>';
            classConfig.subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                select.appendChild(opt);
            });
        }

        function initData() {
            students = classConfig.students.map(entry => {
                return {
                    roll: entry.roll.toString(),
                    name: entry.name,
                    usn: entry.usn || "Unknown",
                    present: true,
                    visible: true,
                    pinned: false
                };
            });
        }


        // This function handles UI recovery on load
        // But actual app start is triggered by Start button
        function restoreUISettings() {
            const lastSub = localStorage.getItem('lastSubject');
            if (lastSub) subjectInput.value = lastSub;

            // Restore settings
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').checked = true;
            }
            if (localStorage.getItem('batterySaver') === 'true') {
                document.body.classList.add('battery-saver');
                document.getElementById('battery-saver-toggle').checked = true;
            }
            checkSubject();
        }

        // Initialize Config immediately on load so dropdown is populated
        initClassConfig();
        restoreUISettings();
        initDates();

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTick() {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        function initDates() {
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            const today = new Date();
            const dateString = today.toLocaleDateString('en-IN', options);
            document.getElementById('welcome-date').textContent = dateString;
            document.getElementById('app-date').textContent = dateString.toUpperCase();
        }

        function checkSubject() {
            const val = subjectInput.value.trim();
            const btn = document.getElementById('start-btn');
            if (val.length > 0) {
                btn.disabled = false;
                btn.style.opacity = "1";
            } else {
                btn.disabled = true;
                btn.style.opacity = "0.7";
            }
        }

        function startApp() {
            const subject = subjectInput.value.trim();
            if (!subject) {
                showToast("Please enter subject name");
                return;
            }

            currentSubject = subject;
            localStorage.setItem('lastSubject', currentSubject);

            document.getElementById('app-subject-title').textContent = currentSubject;

            document.getElementById('welcome-screen').style.opacity = '0';
            document.getElementById('welcome-screen').style.visibility = 'hidden';

            const app = document.getElementById('app-interface');
            app.style.display = 'block';
            setTimeout(() => { app.style.opacity = '1'; }, 50);

            renderStudents();
            updateStats();

            // Start Auto Save
            startAutoSave();

            // Init Audio Context on first interaction
            initAudio();
        }

        function getAvatar(name) { return name.charAt(0).toUpperCase(); }

        function setFilterMode(mode) {
            currentFilter = mode;

            // UI Toggles
            const pillAll = document.getElementById('pill-all');
            const pillAbsent = document.getElementById('pill-absent');

            if (mode === 'all') {
                pillAll.className = 'view-pill active';
                pillAbsent.className = 'view-pill';
            } else {
                pillAll.className = 'view-pill';
                pillAbsent.className = 'view-pill active-absent';
            }

            filterStudents(); // Re-run filter logic
        }

        function renderStudents() {
            studentContainer.innerHTML = '';

            // Double check visibility based on filter
            let visibleCount = 0;

            // Create sortable list with original indices
            let displayList = students.map((s, i) => ({ ...s, originalIndex: i }));

            displayList.sort((a, b) => {
                // Pinned first
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return parseInt(a.roll) - parseInt(b.roll); // Default roll sort
            });

            displayList.forEach((student) => {
                if (!student.visible) return;
                if (currentFilter === 'absent' && student.present) return;

                visibleCount++;

                const originalIndex = student.originalIndex;
                const isFrequent = frequentAbsentees.has(student.roll.toString());
                const card = document.createElement('div');
                card.className = `student-card animate__animated animate__fadeInUp ${student.present ? 'present' : 'absent'} ${student.pinned ? 'pinned' : ''} ${isFrequent ? 'frequent-absent' : ''}`;
                card.style.animationDelay = `${visibleCount * 0.05}s`;

                // Event Listeners for Long Press & Click
                card.onclick = (e) => toggleAttendance(originalIndex, e);
                card.onmousedown = () => startLongPress(originalIndex, card);
                card.onmouseup = cancelLongPress;
                card.onmouseleave = cancelLongPress;
                card.ontouchstart = (e) => { startLongPress(originalIndex, card); };
                card.ontouchend = cancelLongPress;
                card.oncontextmenu = (e) => { e.preventDefault(); return false; };

                card.innerHTML = `
                    <div class="avatar">
                        ${getAvatar(student.name)}
                        <span class="roll-badge">${student.roll}</span>
                    </div>
                    <div class="student-info">
                        <div class="student-name">
                            <span class="pinned-icon">üìå</span>
                            ${student.name}
                        </div>
                        <div class="student-usn">
                            ${isFrequent ? '<span class="warn-icon" title="Frequently Absent">‚ö†Ô∏è</span>' : ''}
                            ${student.usn}
                        </div>
                    </div>
                    <div class="status-toggle">
                         <button style="background:transparent; border:none; margin-right:5px; cursor:pointer; opacity:0.5;" onclick="togglePin(${originalIndex}, event)">${student.pinned ? '‚≠ê' : '‚òÜ'}</button>
                        <button class="toggle-btn present-btn ${student.present ? 'active' : ''}" onclick="setAttendance(${originalIndex}, true, event)">‚úî</button>
                        <button class="toggle-btn absent-btn ${!student.present ? 'active' : ''}" onclick="setAttendance(${originalIndex}, false, event)">‚úñ</button>
                    </div>
                `;
                studentContainer.appendChild(card);
            });

            if (visibleCount === 0 && currentFilter === 'absent') {
                studentContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--primary-teal);">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
                        <h3>No absentees!</h3>
                    </div>
                `;
            } else if (visibleCount === 0) {
                studentContainer.innerHTML = `<div style="text-align:center; padding: 20px; color: #999;">No students found</div>`;
            }
        }

        function setAttendance(index, isPresent, event) {
            if (event) event.stopPropagation();

            // Vibration & Sound Logic
            if (isPresent) {
                if (navigator.vibrate) navigator.vibrate(30);
                playTick();
            } else {
                if (navigator.vibrate) navigator.vibrate([20, 40, 20]);
            }

            // Undo Stack
            const prev = students[index].present;
            if (prev !== isPresent) {
                actionStack.push({ index: index, status: prev });
            }

            students[index].present = isPresent;
            updateStats();

            // If in strict filter mode, re-render to remove/add from view
            if (currentFilter === 'absent') {
                renderStudents();
            } else {
                // Just update visual for performance
                // Can't just renderStudents() every time if we want optimization, 
                // but since we reverted opt, we can render safely or update DOM directly.
                // For simplicity and consistent frequent badge state, we re-render.
                renderStudents();
            }

            triggerAutoSave();
        }

        function startLongPress(index, card) {
            cancelLongPress();
            pressTimer = setTimeout(() => {
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                card.classList.add('shaking');
                setAttendance(index, false); // Mark absent
                showToast("Marked Absent");
            }, 600); // 600ms hold
        }

        function cancelLongPress() {
            if (pressTimer) clearTimeout(pressTimer);
            pressTimer = null;
        }

        function toggleAttendance(index, event) {
            if (event.target.tagName === 'BUTTON') return;
            // Short tap logic is handled here, but long press handles absent.
            // If click fires after long press (mouseup/touchend), we need to prevent toggle?
            // Usually the card click toggles state.
            // If we just marked absent via long press, toggling might switch it back to present.
            // How to prevent?
            // Simple check: if pressTimer fired, don't toggle? 
            // Actually, long press happens *before* click event usually finishes on touchend.
            // But let's assume standard behavior:

            // To simplify, we rely on setAttendance updating state.
            // If vibration happened, we consider it done.
            // However, native click will follow.

            const prev = students[index].present;

            // Standard toggle behavior updates
            if (navigator.vibrate) navigator.vibrate(30);
            playTick();

            actionStack.push({ index: index, status: prev });
            students[index].present = !students[index].present;
            updateStats();
            renderStudents();
            triggerAutoSave();
        }

        function updateStats() {
            const total = students.length;
            const present = students.filter(s => s.present).length;
            const absent = total - present;
            const percentage = total === 0 ? 0 : Math.round((present / total) * 100);
            countPresentEl.textContent = present;
            countAbsentEl.textContent = absent;
            percentageEl.textContent = `${percentage}%`;
            const offset = circumference - (percentage / 100) * circumference;
            ringEl.style.strokeDashoffset = offset;

            strengthEl.textContent = `Total Class Strength: ${total}`;

            if (absent > 0) {
                bubbleEl.style.display = 'flex';
                bubbleEl.innerHTML = `<span>${absent}</span> Absentees <span style="font-size:0.8rem; margin-left:5px">‚¨á</span>`;
                bubbleEl.onclick = scrollToFirstAbsent;
            } else {
                bubbleEl.style.display = 'none';
            }
        }

        function scrollToFirstAbsent() {
            // Find first absent card
            const cards = document.querySelectorAll('.student-card.absent');
            if (cards.length > 0) {
                cards[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                showToast("Jumped to Absentee");
            } else {
                showToast("No absentees found");
            }
        }

        function calculateFrequentAbsentees() {
            frequentAbsentees.clear();
            const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            const counts = {};
            history.forEach(session => {
                session.students.forEach(s => {
                    // History stores status as boolean Present? 
                    // Let's check structure.
                    // Prior code: students: map(s => ({... status: s.present }))
                    // So status=false is absent.
                    if (!s.status) {
                        const key = s.roll;
                        counts[key] = (counts[key] || 0) + 1;
                    }
                });
            });
            // Threshold > 1
            for (let [roll, count] of Object.entries(counts)) {
                if (count > 1) frequentAbsentees.add(roll.toString());
            }
        }

        function togglePin(index, event) {
            if (event) event.stopPropagation();
            students[index].pinned = !students[index].pinned;
            renderStudents();
            showToast(students[index].pinned ? "Student Pinned" : "Unpinned");
        }

        function undoLastAction() {
            if (actionStack.length === 0) {
                showToast("Nothing to undo");
                return;
            }
            const last = actionStack.pop();
            students[last.index].present = last.status;
            updateStats();
            renderStudents();
            showToast("Action Undone");

            // Hide settings after undo
            document.getElementById('settings-menu').style.display = 'none';
        }

        function toggleSettings() {
            const sh = document.getElementById('settings-menu');
            sh.style.display = sh.style.display === 'block' ? 'none' : 'block';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function toggleBatterySaver() {
            document.body.classList.toggle('battery-saver');
            localStorage.setItem('batterySaver', document.body.classList.contains('battery-saver'));
        }

        function markAll(present) {
            students.forEach(s => {
                // Only affect visible if searching? usually mark all implies all displayed or all total. 
                // Standard behavior is usually all visible students or all total. 
                // For safety in this simpler app, we mark ALL so data is consistent.
                s.present = present;
            });
            renderStudents();
            updateStats();
            showToast(present ? "Marked All Present" : "Marked All Absent");
            triggerAutoSave();
        }

        function filterStudents() {
            const query = document.getElementById('search-input').value.toLowerCase();
            students.forEach(student => {
                const searchStr = `${student.name} ${student.roll} ${student.usn}`.toLowerCase();
                student.visible = searchStr.includes(query);
            });
            renderStudents();
        }

        function toggleHistory() {
            const view = document.getElementById('history-view');
            if (view.style.display === 'block') {
                view.style.display = 'none';
            } else {
                renderHistoryList();
                view.style.display = 'block';
            }
        }

        function toggleAbout() {
            const modal = document.getElementById('about-modal');
            if (modal.style.display === 'flex') {
                modal.style.opacity = '0';
                setTimeout(() => modal.style.display = 'none', 300);
            } else {
                modal.style.display = 'flex';
                requestAnimationFrame(() => modal.style.opacity = '1');
            }
        }

        // Close modal on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const aboutModal = document.getElementById('about-modal');
                if (aboutModal.style.display === 'flex') toggleAbout();
            }
        });

        function saveAttendanceRecord() {
            if (viewHistoryMode) return;
            const formattedDate = getFormattedDate();
            const displayDate = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const total = students.length;
            const present = students.filter(s => s.present).length;
            const absent = total - present;
            const percentage = Math.round((present / total) * 100);

            const record = {
                id: Date.now().toString(),
                date: formattedDate,
                displayDate: displayDate,
                subject: currentSubject,
                presentCount: present,
                absentCount: absent,
                percentage: percentage,
                students: students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, status: s.present }))
            };

            let history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            history = history.filter(r => !(r.date === formattedDate && r.subject === currentSubject));
            history.unshift(record);
            localStorage.setItem('attendanceHistory', JSON.stringify(history));
        }

        function renderHistoryList() {
            const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (history.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">No attendance records found.</p>';
                return;
            }
            history.forEach(record => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.innerHTML = `
                    <div class="h-card-header">
                        <span class="h-date">${record.displayDate}</span>
                        <span style="font-weight: bold; color: ${record.percentage >= 75 ? 'green' : 'orange'}">${record.percentage}%</span>
                    </div>
                    <div class="h-subject">${record.subject || 'Unknown Subject'}</div>
                    <div class="h-stats">
                        Present: ${record.presentCount} &bull; Absent: ${record.absentCount}
                    </div>
                    <div class="h-actions">
                        <button class="h-btn primary" onclick="loadHistoryRecord('${record.id || record.date}')">üìÇ Open</button>
                        <button class="h-btn" onclick="downloadHistoryPDF('${record.id || record.date}')">üìÑ PDF</button>
                        <button class="h-btn" style="background:#10B981; color:white; border:none;" onclick="downloadHistoryExcel('${record.id || record.date}')">üìä XLS</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function loadHistoryRecord(identifier) {
            const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            const record = history.find(r => r.id === identifier || r.date === identifier);

            if (record) {
                students = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status, visible: true }));
                viewHistoryMode = true;
                currentRecordDate = record.date;
                currentSubject = record.subject || "Restored Session";

                document.getElementById('app-subject-title').textContent = currentSubject;

                // Reset filter to ALL when loading history
                setFilterMode('all');
                document.getElementById('search-input').value = '';

                updateStats();
                renderStudents(); // Explicit render called by setFilterMode above actually

                document.getElementById('history-view').style.display = 'none';
                document.getElementById('history-banner').style.display = 'block';
                document.getElementById('app-date').textContent = record.displayDate.toUpperCase();

                showToast("Loaded: " + currentSubject);
            }
        }

        function exitHistoryMode() {
            viewHistoryMode = false;
            currentRecordDate = null;
            location.reload();
        }

        function exitHistoryMode() {
            viewHistoryMode = false;
            currentRecordDate = null;
            location.reload();
        }

        // --- Backup & Restore ---

        function backupData() {
            const data = {
                history: localStorage.getItem('attendanceHistory'),
                draft: localStorage.getItem('attendanceDraft'),
                darkMode: localStorage.getItem('darkMode'),
                batterySaver: localStorage.getItem('batterySaver'),
                lastSubject: localStorage.getItem('lastSubject'),
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${getFormattedDate()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Backup Downloaded");
        }

        function triggerRestore() {
            document.getElementById('restore-input').click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.history) localStorage.setItem('attendanceHistory', data.history);
                    if (data.draft) localStorage.setItem('attendanceDraft', data.draft);
                    if (data.darkMode) localStorage.setItem('darkMode', data.darkMode);
                    if (data.batterySaver) localStorage.setItem('batterySaver', data.batterySaver);
                    if (data.lastSubject) localStorage.setItem('lastSubject', data.lastSubject);

                    showToast("Data Restored Successfully");
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    showToast("Invalid Backup File");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function clearHistory() {
            if (confirm('Are you sure you want to delete ALL history?')) {
                localStorage.removeItem('attendanceHistory');
                renderHistoryList();
                showToast("History Cleared");
            }
        }

        // --- Auto Save & Restore Logic ---

        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => {
                saveDraft();
            }, 10000); // 10 seconds
        }

        function stopAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
        }

        function triggerAutoSave() {
            saveDraft();
            // Reset timer to avoid double save
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => {
                saveDraft();
            }, 10000);
        }

        function saveDraft() {
            if (viewHistoryMode) return; // Don't save history views as drafts
            if (!currentSubject) return;

            const total = students.length;
            const present = students.filter(s => s.present).length;
            const absent = total - present;
            const percentage = total === 0 ? 0 : Math.round((present / total) * 100);

            const draft = {
                subject: currentSubject,
                date: getFormattedDate(),
                students: students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, status: s.present, pinned: s.pinned })),
                presentCount: present,
                absentCount: absent,
                percentage: percentage,
                lastSaved: Date.now()
            };

            localStorage.setItem('attendanceDraft', JSON.stringify(draft));
            showAutoSaveIndicator();
        }

        function showAutoSaveIndicator() {
            const el = document.getElementById('auto-save-msg');
            const now = new Date();
            el.textContent = `Saved ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            el.style.opacity = '1';
            setTimeout(() => { el.style.opacity = '0'; }, 3000);
        }

        function checkForDrafts() {
            const draft = localStorage.getItem('attendanceDraft');
            if (draft) {
                const data = JSON.parse(draft);
                // Check if draft is from today? Or just any unsaved work. PROMPT USER.
                const draftDate = new Date(data.lastSaved);
                document.getElementById('draft-time').textContent = draftDate.toLocaleString();
                document.getElementById('restore-modal').style.display = 'flex';
            }
        }

        function discardDraft() {
            localStorage.removeItem('attendanceDraft');
            document.getElementById('restore-modal').style.display = 'none';
        }

        function restoreDraft() {
            const draft = JSON.parse(localStorage.getItem('attendanceDraft'));
            if (!draft) return;

            // Load data
            currentSubject = draft.subject;
            localStorage.setItem('lastSubject', currentSubject);

            // Merge students with draft status (preserve structure if raw data updated, but here we trust draft for session)
            // Ideally we map draft status back to current student list to support roster updates.
            // Simplified: Map draft statuses to student list by Roll/Name

            // Reset students from raw header but update status
            students.forEach(s => {
                const draftStudent = draft.students.find(ds => ds.roll === s.roll || ds.name === s.name);
                if (draftStudent) {
                    s.present = draftStudent.status;
                    s.pinned = draftStudent.pinned || false;
                }
            });

            // UI Setup
            document.getElementById('app-subject-title').textContent = currentSubject;
            document.getElementById('welcome-screen').style.opacity = '0';
            document.getElementById('welcome-screen').style.visibility = 'hidden';

            const app = document.getElementById('app-interface');
            app.style.display = 'block';
            setTimeout(() => { app.style.opacity = '1'; }, 50);

            renderStudents();
            updateStats();
            document.getElementById('restore-modal').style.display = 'none';
            showToast("Draft Restored");

            startAutoSave();
        }

        function clearDraft() {
            localStorage.removeItem('attendanceDraft');
            stopAutoSave();
        }

        // Note: Update resetApp and download functions to clear draft

        function downloadHistoryPDF(identifier) {
            const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            const record = history.find(r => r.id === identifier || r.date === identifier);
            if (record) {
                const recordStudents = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status }));
                // We use generateAbsenteePDF for history PDF as per requirement, or we could add generateFullPDF for history.
                // Reusing GenerateAbsenteePDF logic for history items as it seems to handle customStudents.
                // But wait, the user might want full list. The requirement says "Clicking exports Excel for that saved date".
                // For PDF, existing behavior was "generateAbsenteePDF".
                generateAbsenteePDF(recordStudents, record.date, record.subject, true);
            }
        }

        function downloadHistoryExcel(identifier) {
            const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
            const record = history.find(r => r.id === identifier || r.date === identifier);
            if (record) {
                const recordStudents = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status }));
                generateExcel(recordStudents, record.date, record.subject, true);
            }
        }

        function resetApp() {
            if (viewHistoryMode) {
                if (confirm('Exit view mode?')) location.reload();
                return;
            }
            if (confirm('Finish session and save?')) {
                saveAttendanceRecord();
                clearDraft();
                showSummaryScreen();
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<span>${msg}</span>`;
            toast.className = 'toast show';
            setTimeout(() => { toast.className = 'toast'; }, 2000);
        }

        function getFormattedDate(dateObj = new Date()) {
            return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
        }

        async function generateAbsenteePDF(customStudents = null, customDateString = null, customSubject = null, isReprint = false) {
            const targetStudents = customStudents || students;
            const targetSubject = customSubject || currentSubject;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFont("times", "bold");
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("LIST OF ABSENTEES", pageWidth / 2, 20, null, null, "center");

            doc.setLineWidth(0.5);
            doc.line(20, 25, pageWidth - 20, 25);

            doc.setFont("times", "normal");
            doc.setFontSize(11);

            let displayDate = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (customDateString) {
                displayDate = new Date(customDateString).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }

            doc.text(`Subject: ${targetSubject}`, 14, 35);
            doc.text(`Date: ${displayDate}`, 14, 42);

            const absentStudents = targetStudents.filter(s => !s.present);

            if (absentStudents.length === 0) {
                doc.setFont("times", "italic");
                doc.text("Nil (No Absentees)", 14, 55);
            } else {
                const tableData = absentStudents.map((s, index) => [(index + 1).toString(), s.roll, s.usn, s.name]);

                doc.autoTable({
                    head: [['S.No', 'Roll', 'USN', 'Student Name']],
                    body: tableData,
                    startY: 50,
                    theme: 'plain',
                    styles: { font: 'times', fontSize: 10, cellPadding: 4, lineColor: [0, 0, 0], lineWidth: 0.1, textColor: [0, 0, 0] },
                    headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [0, 0, 0] },
                    columnStyles: { 0: { cellWidth: 15, halign: 'center' }, 1: { cellWidth: 20 }, 2: { cellWidth: 40 }, 3: { cellWidth: 'auto' } }
                });
            }

            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 60;
            doc.setFont("times", "normal");
            doc.setFontSize(10);
            doc.text("Faculty Signature", pageWidth - 50, finalY + 30, null, null, "center");

            const safeSub = targetSubject.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
            const fname = customDateString ? `Attendance_${safeSub}_${customDateString}.pdf` : `Attendance_${safeSub}_${getFormattedDate()}.pdf`;

            doc.save(fname);

            if (!customStudents) {
                if (!isReprint) {
                    saveAttendanceRecord();
                    clearDraft();
                }
                showSummaryScreen();
                showToast("Saved & Downloaded");
            } else {
                showToast("History Downloaded");
            }
        }

        async function generateFullPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFont("times", "bold");
            doc.setFontSize(16);
            doc.text("ATTENDANCE REGISTER", pageWidth / 2, 20, null, null, "center");

            doc.setFont("times", "normal");
            doc.setFontSize(11);
            doc.text(`Subject: ${currentSubject}`, 14, 30);
            doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 14, 37);

            const tableData = students.map(s => [s.roll, s.usn, s.name, s.present ? 'P' : 'A']);

            doc.autoTable({
                head: [['Roll', 'USN', 'Name', 'Status']],
                body: tableData,
                startY: 45,
                theme: 'grid',
                styles: { font: 'times', fontSize: 9 },
                headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                didParseCell: function (data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        data.cell.styles.textColor = data.cell.raw === 'A' ? [255, 0, 0] : [0, 128, 0];
                    }
                }
            });

            const safeSub = currentSubject.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
            doc.save(`Full_Attendance_${safeSub}_${getFormattedDate()}.pdf`);
            saveAttendanceRecord();
            clearDraft();
            showSummaryScreen();
            showToast("Saved & Downloaded");
        }

        function copyTextReport() {
            const dateStr = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
            const absentList = students.filter(s => !s.present);
            let text = `Attendance Report - ${currentSubject} (${dateStr})\n`;
            text += `Total: ${students.length} | Present: ${students.filter(s => s.present).length} | Absent: ${absentList.length}\n\n`;
            if (absentList.length === 0) { text += "All Present."; }
            else { text += "Absentees:\n"; absentList.forEach(s => { text += `[${s.roll}]${s.pinned ? '‚≠ê' : ''} ${s.name} (${s.usn})\n`; }); }
            navigator.clipboard.writeText(text).then(() => { showToast("üìã Copied to clipboard!"); }).catch(err => { showToast("‚ùå Failed to copy"); });
        }

        function shareToWhatsApp() {
            const dateStr = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
            const absentList = students.filter(s => !s.present);
            let text = `*Attendance Report - ${currentSubject} (${dateStr})*\n`;
            text += `Total: ${students.length} | Present: ${students.filter(s => s.present).length} | Absent: ${absentList.length}\n\n`;

            if (absentList.length === 0) {
                text += "All Present. üéâ";
            } else {
                text += "*Absentees:*\n";
                absentList.forEach(s => {
                    text += `‚Ä¢ ${s.name} (${s.roll})\n`;
                });
            }

            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function generateExcel(customStudents = null, customDateString = null, customSubject = null, isReprint = false) {
            const targetStudents = customStudents || students;
            const targetSubject = customSubject || currentSubject;
            const dateStr = customDateString || getFormattedDate();

            if (!targetStudents || targetStudents.length === 0) {
                showToast("No data to export");
                return;
            }

            // Prepare Data for SheetJS
            // Format: Roll | USN | Name | Status | Subject | Date
            const data = targetStudents.map(s => ({
                "Roll": s.roll,
                "USN": s.usn,
                "Name": s.name,
                "Status": s.present ? "Present" : "Absent",
                "Subject": targetSubject,
                "Date": dateStr
            }));

            // Create Worksheet
            const ws = XLSX.utils.json_to_sheet(data);

            // Create Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");

            // Generate Filename
            const safeSub = targetSubject.replace(/[^a-z0-9]/gi, '');
            const filename = `Attendance_${safeSub}_${dateStr}.xlsx`;

            // Download
            XLSX.writeFile(wb, filename);

            showToast("Excel Downloaded Successfully");
        }

        // --- Backup & Restore ---

        function backupData() {
            const data = {
                history: localStorage.getItem('attendanceHistory'),
                draft: localStorage.getItem('attendanceDraft'),
                darkMode: localStorage.getItem('darkMode'),
                batterySaver: localStorage.getItem('batterySaver'),
                lastSubject: localStorage.getItem('lastSubject'),
                classConfig: localStorage.getItem('classConfig'),
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${getFormattedDate()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Backup Downloaded");
        }

        function triggerRestore() {
            document.getElementById('restore-input').click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.history) localStorage.setItem('attendanceHistory', data.history);
                    if (data.draft) localStorage.setItem('attendanceDraft', data.draft);
                    if (data.darkMode) localStorage.setItem('darkMode', data.darkMode);
                    if (data.batterySaver) localStorage.setItem('batterySaver', data.batterySaver);
                    if (data.lastSubject) localStorage.setItem('lastSubject', data.lastSubject);
                    if (data.classConfig) localStorage.setItem('classConfig', data.classConfig);

                    showToast("Data Restored Successfully");
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    showToast("Invalid Backup File");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- Manager Functions ---

        function openManageModal() {
            document.getElementById('manage-modal').style.display = 'flex';
            document.getElementById('settings-menu').style.display = 'none'; // Close settings
            switchManageTab('students');
        }

        function closeManageModal() {
            document.getElementById('manage-modal').style.display = 'none';
        }

        function switchManageTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.manage-content').forEach(c => c.style.display = 'none');

            if (tab === 'students') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('manage-content-students').style.display = 'block';
                renderManageStudents();
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('manage-content-subjects').style.display = 'block';
                renderManageSubjects();
            }
        }

        function renderManageStudents() {
            const list = document.getElementById('manage-student-list');
            list.innerHTML = '';
            classConfig.students.forEach((s, idx) => {
                const item = document.createElement('div');
                item.className = 'manage-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight:700;">${s.roll}. ${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${s.usn}</div>
                    </div>
                    <button onclick="deleteStudent(${idx})">üóë</button>
                `;
                list.appendChild(item);
            });
        }

        function addStudent() {
            const name = document.getElementById('new-s-name').value;
            const roll = document.getElementById('new-s-roll').value;
            const usn = document.getElementById('new-s-usn').value;

            if (!name || !roll) return showToast("Name and Roll required");

            classConfig.students.push({
                roll: roll,
                name: name,
                usn: usn || "Unknown"
            });
            // Auto sort by roll
            classConfig.students.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

            document.getElementById('new-s-name').value = '';
            document.getElementById('new-s-roll').value = '';
            document.getElementById('new-s-usn').value = '';
            renderManageStudents();
        }

        function deleteStudent(index) {
            if (confirm("Remove this student?")) {
                classConfig.students.splice(index, 1);
                renderManageStudents();
            }
        }

        function renderManageSubjects() {
            const list = document.getElementById('manage-subject-list');
            list.innerHTML = '';
            classConfig.subjects.forEach((sub, idx) => {
                const item = document.createElement('div');
                item.className = 'manage-item';
                item.innerHTML = `
                    <div>${sub}</div>
                    <button onclick="deleteSubject(${idx})">üóë</button>
                `;
                list.appendChild(item);
            });
        }

        function addSubject() {
            const sub = document.getElementById('new-subject').value;
            if (!sub) return;
            classConfig.subjects.push(sub);
            document.getElementById('new-subject').value = '';
            renderManageSubjects();
        }

        function deleteSubject(index) {
            if (confirm("Delete this subject?")) {
                classConfig.subjects.splice(index, 1);
                renderManageSubjects();
            }
        }

        function saveConfig() {
            localStorage.setItem('classConfig', JSON.stringify(classConfig));
        }

        function saveAndCloseManage() {
            saveConfig();
            location.reload();
        }

        initData();
        initDates();

        // ==========================================
        // PWA - Progressive Web App Support
        // ==========================================

        let deferredPrompt = null;

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available
                                    showUpdateToast();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });

                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'SW_UPDATED') {
                        showToast(`Update available (${event.data.version}). Refresh to apply.`);
                    }
                });
            });
        }

        // Handle beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome's mini-infobar
            e.preventDefault();
            // Store the event for later use
            deferredPrompt = e;
            // Show install button
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.style.display = 'flex';
            }
            console.log('[PWA] Install prompt ready');
        });

        // Handle app installed event
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed successfully');
            deferredPrompt = null;
            // Hide install button
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
            showToast('üéâ App installed successfully!');
        });

        // Install PWA function
        function installPWA() {
            if (!deferredPrompt) {
                showToast('App is already installed or not supported');
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user's response
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('[PWA] User accepted the install prompt');
                } else {
                    console.log('[PWA] User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        }

        // Show update toast with refresh option
        function showUpdateToast() {
            const toast = document.createElement('div');
            toast.className = 'toast update-toast';
            toast.innerHTML = `
                <span>üîÑ New version available!</span>
                <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: white; color: #004E89; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    Refresh
                </button>
            `;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary-blue);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                z-index: 9999;
                display: flex;
                align-items: center;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(toast);

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 10000);
        }

        // Check if running as PWA/standalone
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true ||
                document.referrer.includes('android-app://');
        }

        // Log PWA status
        if (isPWA()) {
            console.log('[PWA] Running in standalone mode');
        } else {
            console.log('[PWA] Running in browser mode');
        }
    </script>
</body>

</html>