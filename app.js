// Default Data for Reset/Init
const defaultStudentList = [
    { roll: 1, name: "ANSH KATIYAR", usn: "ENG25CS0399" },
    { roll: 2, name: "ANSHI DEEP SINHA", usn: "ENG25DS0082" },
    { roll: 3, name: "ANSHUMAN KUMAR", usn: "ENG25CS0400" },
    { roll: 4, name: "ANTARIKSH BORAH", usn: "ENG25AM0222" },
    { roll: 5, name: "ANUSHKA MISHRA", usn: "ENG25CS0407" },
    { roll: 6, name: "ANUSHKA SRIVASTAVA", usn: "ENG25CS0408" },
    { roll: 7, name: "ARGHITH JAIN PAMRITHRAJ", usn: "ENG25AM0224" },
    { roll: 8, name: "ARITRAA DAS", usn: "ENG25AM0226" },
    { roll: 9, name: "ARJUN HANVI", usn: "ENG25AM0227" },
    { roll: 10, name: "ARJUN P", usn: "ENG25CS0413" },
    { roll: 11, name: "ARKA DAS", usn: "ENG25CY0082" },
    { roll: 12, name: "ARMAN KUMAR", usn: "ENG25AM0228" },
    { roll: 13, name: "ARNAV CHOUDHARY", usn: "ENG25CS0414" },
    { roll: 14, name: "ARPIT KIRAN", usn: "Unknown" },
    { roll: 15, name: "ARUNKUMAR PATIL", usn: "ENG25CS0417" },
    { roll: 16, name: "ARYAN ANAND", usn: "ENG25CS0420" },
    { roll: 17, name: "ARYAN BHARDWAJ", usn: "ENG25AM0229" },
    { roll: 18, name: "ARYAN MADHOK", usn: "Unknown" },
    { roll: 19, name: "ASHISH UPADHYAY", usn: "ENG25AM0231" },
    { roll: 20, name: "ASHIT KIRAN REDDY", usn: "ENG25AM0232" },
    { roll: 21, name: "ASHITH PRAJWAL", usn: "ENG25CS0422" },
    { roll: 22, name: "ASHITOSH SHARMA", usn: "ENG25CS0423" },
    { roll: 23, name: "AYUSH MODI", usn: "ENG25CY0085" },
    { roll: 24, name: "AYUSH RAJ", usn: "ENG25CS0431" },
    { roll: 25, name: "AYUSH RAJ", usn: "ENG25CY0086" },
    { roll: 26, name: "AYUSH SAO", usn: "ENG25AM0235" },
    { roll: 27, name: "CHETAN REDDY", usn: "ENG25AM0237" },
    { roll: 28, name: "B DAMARA REDDY", usn: "" },
    { roll: 29, name: "B HARSHAVARDHAN", usn: "ENG25CS0433" },
    { roll: 30, name: "B MITHRAN REDDY", usn: "ENG25AM0239" },
    { roll: 31, name: "B ROHAN POWLEY", usn: "" },
    { roll: 32, name: "BARANIDHARAN K", usn: "ENG25CS0440" },
    { roll: 33, name: "BESTHA DHARANEESH BALAJI", usn: "ENG25CS0442" },
    { roll: 34, name: "BHANU PRAKASH PENAMALE VENKATARANGA R", usn: "ENG25CS0443" },
    { roll: 35, name: "BHAVYA", usn: "ENG25CS0445" },
    { roll: 36, name: "BHAVYA", usn: "ENG25CS0446" },
    { roll: 37, name: "BHUMA PRANEETH REDDY", usn: "ENG25CS0648" },
    { roll: 38, name: "BHUVAN K Y", usn: "ENG25RA0058" },
    { roll: 39, name: "BINDUSARA GOWDA G S", usn: "ENG25CS0452" },
    { roll: 40, name: "BINDYA P", usn: "ENG25DS0086" },
    { roll: 41, name: "BINOD BISHWAKARAMA", usn: "ENG25CS0453" },
    { roll: 42, name: "BOJJA JITHI", usn: "ENG25CS0455" },
    { roll: 43, name: "BOMMANA NITHISH REDDY", usn: "ENG25CS0456" },
    { roll: 44, name: "BONALA ABHINAV KUMAR REDDY", usn: "ENG25AM0248" },
    { roll: 45, name: "BONTHA ASRITH REDDY", usn: "ENG25AM0249" },
    { roll: 46, name: "C DHANUSH", usn: "ENG25CY0090" },
    { roll: 47, name: "C M HALEEMA SADIYA", usn: "ENG25AM0250" },
    { roll: 48, name: "C SHREEJAN", usn: "ENG25AM0251" },
    { roll: 49, name: "CHADALAVADA MANVIT", usn: "ENG25CS0460" },
    { roll: 50, name: "CHADIVE KARTHIKEYA REDDY", usn: "ENG25CS0461" },
    { roll: 51, name: "CHAKRALA NAVYA", usn: "ENG25CS0462" },
    { roll: 52, name: "CHALLA VENKATA SAI KOTI REDDY", usn: "ENG25RA0059" },
    { roll: 53, name: "CHANDAN K S", usn: "ENG25AM0252" },
    { roll: 54, name: "CHANDHAN REDDY J B", usn: "ENG25AM0254" },
    { roll: 55, name: "CHARAN M REDDY", usn: "ENG25AM0255" },
    { roll: 56, name: "CHEKKA YASHWANTH", usn: "ENG25AM0258" },
    { roll: 57, name: "D REKHA SHRI", usn: "" },
    { roll: 58, name: "D THANUJ", usn: "ENG25AD0103" },
    { roll: 59, name: "DAKSH SHAH", usn: "ENG25CS0472" },
    { roll: 60, name: "DANDU MOHAN CHAITHANYA", usn: "ENG25CS0473" },
    { roll: 61, name: "DANIYA FATIMA", usn: "ENG25CS0474" },
    { roll: 62, name: "DARSHAN KALAL", usn: "ENG25AM0263" },
    { roll: 63, name: "DEBADRITA PANDA", usn: "ENG25DS0092" },
    { roll: 64, name: "DEENATHAYALAN", usn: "ENG25AD0106" },
    { roll: 65, name: "DEEPAK SHANMUGAM", usn: "ENG25CS0479" },
    { roll: 66, name: "DEVANGA PUNITH SAI KUMAR", usn: "ENG25AM0267" },
    { roll: 67, name: "DEVESH AGRE", usn: "ENG25CS0481" },
    { roll: 68, name: "DHRUV SHARMA", usn: "ENG25AM0273" },
    { roll: 69, name: "DIYA MEENAKSHI J", usn: "ENG25DS0095" },
    { roll: 70, name: "S ROHIL", usn: "ENG25CS0998" }
];

let students = [];
let viewHistoryMode = false;
let currentRecordDate = null;
let currentSubject = "";
let currentFilter = "all"; // all | absent
let actionStack = []; // For Undo
let autoSaveInterval = null;

// UX State
let frequentAbsentees = new Set();
let pressTimer = null;
let audioCtx = null;

const studentContainer = document.getElementById('students-container');
const countPresentEl = document.getElementById('count-present');
const countAbsentEl = document.getElementById('count-absent');
const percentageEl = document.getElementById('stats-percentage');
const ringEl = document.getElementById('progress-ring');

const subjectInput = document.getElementById('subject-input');
const strengthEl = document.getElementById('class-strength');
const bubbleEl = document.getElementById('floating-bubble');
const circumference = 163;

let classConfig = { students: [], subjects: [] };
let allClasses = []; // Array of all classes
let currentClassId = null; // Currently selected class ID

// Multi-Class Management Functions
function initMultiClass() {
    const savedClasses = localStorage.getItem('allClasses');
    const savedCurrentId = localStorage.getItem('currentClassId');
    const migrationVersion = localStorage.getItem('multiClassMigrationV3'); // Updated version

    // Check if existing data has students - if not, force re-migrate
    let needsRemigration = false;
    if (savedClasses && migrationVersion) {
        try {
            const classes = JSON.parse(savedClasses);
            if (classes.length > 0 && classes[0].students && classes[0].students.length === 0) {
                // Empty students, need to re-migrate
                needsRemigration = true;
            }
        } catch (e) {
            needsRemigration = true;
        }
    }

    // One-time fix: Re-migrate if old migration had issues
    if ((savedClasses && !migrationVersion) || needsRemigration) {
        // Clear old multi-class data and re-migrate
        localStorage.removeItem('allClasses');
        localStorage.removeItem('currentClassId');
        localStorage.setItem('multiClassMigrationV3', 'done');
        // Continue to migration below
    } else if (savedClasses && migrationVersion) {
        allClasses = JSON.parse(savedClasses);
        currentClassId = savedCurrentId || (allClasses.length > 0 ? allClasses[0].id : null);

        // Ensure current class exists
        if (!allClasses.find(c => c.id === currentClassId) && allClasses.length > 0) {
            currentClassId = allClasses[0].id;
        }

        renderClassSelector();
        loadCurrentClass();
        return;
    }

    // Migrate existing single class to multi-class system
    const existingConfig = localStorage.getItem('classConfig');
    let studentsData = defaultStudentList;
    let subjectsData = ["Physics", "Maths", "Electrical Engineering", "Biology", "Sustainable Engineering", "C Programming", "Constitution And Law"];

    if (existingConfig) {
        try {
            const config = JSON.parse(existingConfig);
            if (config.students && config.students.length > 0) {
                studentsData = config.students;
            }
            if (config.subjects && config.subjects.length > 0) {
                subjectsData = config.subjects;
            }
        } catch (e) {
            console.error('Error parsing existing config:', e);
        }
    }

    // Create default class with user's actual data
    const defaultClass = {
        id: 'class_' + Date.now(),
        name: '1st Year CSE',
        section: 'A9',
        students: studentsData,
        subjects: subjectsData
    };
    allClasses = [defaultClass];
    currentClassId = defaultClass.id;
    localStorage.setItem('multiClassMigrationV3', 'done');
    saveAllClasses();

    renderClassSelector();
    loadCurrentClass();
}

// Force reload students from default list
function forceReloadDefaultStudents() {
    const currentClass = getCurrentClass();
    if (currentClass) {
        currentClass.students = [...defaultStudentList];
        currentClass.name = '1st Year CSE';
        currentClass.section = 'A9';
        saveAllClasses();
        loadCurrentClass();
        initData();
        renderStudents();
        showToast('Loaded ' + defaultStudentList.length + ' students');
    }
}

function saveAllClasses() {
    localStorage.setItem('allClasses', JSON.stringify(allClasses));
    localStorage.setItem('currentClassId', currentClassId);
}

function getCurrentClass() {
    return allClasses.find(c => c.id === currentClassId) || allClasses[0];
}

function renderClassSelector() {
    const selector = document.getElementById('class-selector');
    if (!selector) return;

    selector.innerHTML = '';

    // Always add placeholder on Welcome screen
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select Class';
    placeholder.disabled = true;
    // Select placeholder only if on welcome screen (not in app)
    const appInterface = document.getElementById('app-interface');
    const isInApp = appInterface && appInterface.style.display === 'block';
    placeholder.selected = !isInApp;
    selector.appendChild(placeholder);

    allClasses.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls.id;
        opt.textContent = `${cls.name} - ${cls.section}`;
        // Only auto-select if we're in the app
        if (cls.id === currentClassId && isInApp) {
            opt.selected = true;
        }
        selector.appendChild(opt);
    });

    // Update header badge
    const badge = document.getElementById('class-badge-text');
    const currentClass = getCurrentClass();
    if (badge && currentClass) {
        badge.textContent = `${currentClass.name} ${currentClass.section}`;
    }

    // Trigger checkSubject to update button state
    checkSubject();
}

function switchClass() {
    const selector = document.getElementById('class-selector');
    if (!selector) return;

    const newClassId = selector.value;
    if (newClassId && newClassId !== currentClassId) {
        // Save current class state before switching
        if (currentClassId) {
            saveCurrentClassState();
        }

        currentClassId = newClassId;
        saveAllClasses();
        loadCurrentClass();
        renderClassSelector();
        renderSubjectsDropdown();
        initData();
        showToast('Switched to ' + getCurrentClass().name + ' ' + getCurrentClass().section);
    }
}

function loadCurrentClass() {
    const currentClass = getCurrentClass();
    if (!currentClass) return;

    classConfig = {
        students: currentClass.students,
        subjects: currentClass.subjects
    };

    // Update localStorage for compatibility
    localStorage.setItem('classConfig', JSON.stringify(classConfig));
}

function saveCurrentClassState() {
    const currentClass = getCurrentClass();
    if (!currentClass) return;

    currentClass.students = classConfig.students;
    currentClass.subjects = classConfig.subjects;
    saveAllClasses();
}

// Temporary subjects array for new class creation
let newClassSubjects = [];

function openAddClassModal() {
    document.getElementById('add-class-modal').style.display = 'flex';
    document.getElementById('new-class-name').value = '';
    document.getElementById('new-class-section').value = '';
    document.getElementById('new-class-subject-input').value = '';

    // Initialize with some default subjects
    newClassSubjects = ['Subject 1', 'Subject 2', 'Subject 3'];
    renderNewClassSubjects();

    document.getElementById('new-class-name').focus();
}

function renderNewClassSubjects() {
    const list = document.getElementById('new-class-subjects-list');
    list.innerHTML = '';

    if (newClassSubjects.length === 0) {
        list.innerHTML = '<div style="color: #999; font-size: 0.9rem; text-align: center; padding: 10px;">No subjects added yet</div>';
        return;
    }

    newClassSubjects.forEach((sub, idx) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; align-items: center; gap: 8px;';
        item.innerHTML = `
            <input type="text" value="${sub}" 
                onchange="updateNewClassSubject(${idx}, this.value)"
                style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
            <button onclick="deleteNewClassSubject(${idx})" 
                style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">🗑</button>
        `;
        list.appendChild(item);
    });
}

function addNewClassSubject() {
    const input = document.getElementById('new-class-subject-input');
    const subject = input.value.trim();

    if (!subject) {
        showToast('Enter a subject name');
        return;
    }

    newClassSubjects.push(subject);
    input.value = '';
    renderNewClassSubjects();
}

function updateNewClassSubject(index, newName) {
    if (newName && newName.trim()) {
        newClassSubjects[index] = newName.trim();
    }
}

function deleteNewClassSubject(index) {
    newClassSubjects.splice(index, 1);
    renderNewClassSubjects();
}

function closeAddClassModal() {
    document.getElementById('add-class-modal').style.display = 'none';
    newClassSubjects = [];
}

function createNewClass() {
    const name = document.getElementById('new-class-name').value.trim();
    const section = document.getElementById('new-class-section').value.trim() || 'A';

    if (!name) {
        showToast('Please enter a class name');
        return;
    }

    if (newClassSubjects.length === 0) {
        showToast('Please add at least one subject');
        return;
    }

    const newClass = {
        id: 'class_' + Date.now(),
        name: name,
        section: section,
        students: [],
        subjects: [...newClassSubjects]
    };

    allClasses.push(newClass);
    currentClassId = newClass.id;
    saveAllClasses();
    loadCurrentClass();
    renderClassSelector();
    renderSubjectsDropdown();
    closeAddClassModal();

    showToast('Created: ' + name + ' ' + section);

    // Open manage modal to add students
    setTimeout(() => {
        openManageModal();
    }, 500);
}

function openManageClassesModal() {
    closeSettingsMenu();
    const modal = document.getElementById('manage-classes-modal');
    const list = document.getElementById('classes-list');

    list.innerHTML = '';
    allClasses.forEach(cls => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f5f5f5; border-radius: 10px;';
        item.innerHTML = `
            <div>
                <div style="font-weight: 600;">${cls.name} - ${cls.section}</div>
                <div style="font-size: 0.85rem; color: #666;">${cls.students.length} students • ${cls.subjects.length} subjects</div>
            </div>
            <div style="display: flex; gap: 8px;">
                ${cls.id === currentClassId ? '<span style="padding: 4px 10px; background: var(--primary-teal); color: white; border-radius: 12px; font-size: 0.75rem;">Active</span>' :
                `<button onclick="quickSwitchClass('${cls.id}')" style="padding: 6px 12px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">Switch</button>`}
                <button onclick="deleteClass('${cls.id}')" style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">🗑</button>
            </div>
        `;
        list.appendChild(item);
    });

    modal.style.display = 'flex';
}

function closeManageClassesModal() {
    document.getElementById('manage-classes-modal').style.display = 'none';
}

function quickSwitchClass(classId) {
    saveCurrentClassState();
    currentClassId = classId;
    saveAllClasses();
    loadCurrentClass();
    renderClassSelector();
    renderSubjectsDropdown();
    initData();
    closeManageClassesModal();
    showToast('Switched to ' + getCurrentClass().name + ' ' + getCurrentClass().section);
}

function deleteClass(classId) {
    const cls = allClasses.find(c => c.id === classId);
    if (!cls) return;

    const confirmMsg = allClasses.length <= 1
        ? `Delete "${cls.name} - ${cls.section}"? This is your only class. A new empty class will be created.`
        : `Delete "${cls.name} - ${cls.section}"? This will remove all students and attendance history for this class.`;

    if (!confirm(confirmMsg)) {
        return;
    }

    allClasses = allClasses.filter(c => c.id !== classId);

    // If no classes left, create a new empty one
    if (allClasses.length === 0) {
        const newClass = {
            id: 'class_' + Date.now(),
            name: 'New Class',
            section: 'A',
            students: [],
            subjects: ['Subject 1', 'Subject 2', 'Subject 3']
        };
        allClasses.push(newClass);
        currentClassId = newClass.id;
    } else if (currentClassId === classId) {
        currentClassId = allClasses[0].id;
    }

    loadCurrentClass();
    renderSubjectsDropdown();
    renderClassSelector();
    initData();
    saveAllClasses();
    openManageClassesModal(); // Refresh the list
    showToast('Class deleted');
}

function showClassSwitcher() {
    const modal = document.getElementById('class-switcher-modal');
    const list = document.getElementById('class-switcher-list');

    list.innerHTML = '';
    allClasses.forEach(cls => {
        const btn = document.createElement('button');
        btn.style.cssText = `
            width: 100%; padding: 12px 16px; text-align: left; border-radius: 10px; cursor: pointer; transition: all 0.2s;
            background: ${cls.id === currentClassId ? 'var(--primary-blue)' : '#f5f5f5'};
            color: ${cls.id === currentClassId ? 'white' : '#333'};
            border: ${cls.id === currentClassId ? 'none' : '1px solid #ddd'};
            font-weight: 600;
        `;
        btn.innerHTML = `
            <div>${cls.name} - ${cls.section}</div>
            <div style="font-size: 0.8rem; opacity: 0.8; font-weight: 400;">${cls.students.length} students</div>
        `;
        btn.onclick = () => {
            if (cls.id !== currentClassId) {
                quickSwitchClass(cls.id);
            }
            closeClassSwitcher();
        };
        list.appendChild(btn);
    });

    modal.style.display = 'flex';
}

function closeClassSwitcher() {
    document.getElementById('class-switcher-modal').style.display = 'none';
}

function initApp() {
    // Debug: Log localStorage state on load
    console.log('🔍 App Init - localStorage state:', {
        allClasses: localStorage.getItem('allClasses') ? JSON.parse(localStorage.getItem('allClasses')).length + ' classes' : 'empty',
        currentClassId: localStorage.getItem('currentClassId'),
        attendanceHistory: localStorage.getItem('attendanceHistory') ? JSON.parse(localStorage.getItem('attendanceHistory')).length + ' records' : 'empty',
        attendanceDraft: localStorage.getItem('attendanceDraft') ? 'exists' : 'none',
        migrationV3: localStorage.getItem('multiClassMigrationV3')
    });

    // Restore Settings
    if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();
    if (localStorage.getItem('batterySaver') === 'true') toggleBatterySaver();

    initClassConfig();
    initData();
    initDates();
    renderStudents();
    updateStats();

    // Check for drafts
    checkForDrafts();
    calculateFrequentAbsentees();

    // Debug: Log after initialization
    console.log('✅ After init - students:', students.length, 'classes:', allClasses.length);
}

function initClassConfig() {
    // Initialize multi-class system first
    initMultiClass();

    // classConfig is now loaded via loadCurrentClass() called in initMultiClass()
    renderSubjectsDropdown();
}

function renderSubjectsDropdown() {
    const select = document.getElementById('subject-input');
    console.log('🎓 Rendering subjects:', classConfig.subjects);
    select.innerHTML = '<option value="" disabled selected>Select Subject</option>';
    classConfig.subjects.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        select.appendChild(opt);
    });
}

function initData() {
    students = classConfig.students.map(entry => {
        return {
            roll: entry.roll.toString(),
            name: entry.name,
            usn: entry.usn || "Unknown",
            present: true,
            visible: true,
            pinned: false
        };
    });
}


// This function handles UI recovery on load
// But actual app start is triggered by Start button
function restoreUISettings() {
    const lastSub = localStorage.getItem('lastSubject');
    if (lastSub) subjectInput.value = lastSub;

    // Restore settings
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('dark-mode-toggle').checked = true;
    }
    if (localStorage.getItem('batterySaver') === 'true') {
        document.body.classList.add('battery-saver');
        document.getElementById('battery-saver-toggle').checked = true;
    }
    // Restore sound setting
    const soundToggle = document.getElementById('sound-toggle');
    if (soundToggle) {
        soundToggle.checked = localStorage.getItem('soundEnabled') !== 'false';
    }
    checkSubject();
}

// ============ OFFLINE SYNC INDICATOR ============
let isOnline = navigator.onLine;
let pendingSyncs = [];
let networkStatusTimeout = null;

function initNetworkStatus() {
    // Set initial state
    updateOfflineBadge();

    // Listen for online/offline events
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
}

function handleOffline() {
    isOnline = false;
    updateOfflineBadge();
    showNetworkStatus('offline', '📡 You are offline - Changes saved locally');
}

function handleOnline() {
    isOnline = true;
    updateOfflineBadge();

    // Check for pending syncs
    const pendingCount = getPendingSyncCount();
    if (pendingCount > 0) {
        showNetworkStatus('syncing', `🔄 Back online - Syncing ${pendingCount} pending changes...`);
        syncPendingChanges();
    } else {
        showNetworkStatus('online', '✅ Back online');
    }
}

function updateOfflineBadge() {
    const badge = document.getElementById('offline-badge');
    if (badge) {
        if (!isOnline) {
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }
}

function showNetworkStatus(type, message) {
    const banner = document.getElementById('network-status');
    const text = document.getElementById('network-status-text');

    if (!banner || !text) return;

    // Clear any existing timeout
    if (networkStatusTimeout) {
        clearTimeout(networkStatusTimeout);
    }

    // Remove all type classes
    banner.classList.remove('offline', 'online', 'syncing');
    banner.classList.add(type);

    text.textContent = message;
    banner.classList.add('show');

    // Auto-hide after delay (except for offline which stays)
    if (type !== 'offline') {
        networkStatusTimeout = setTimeout(() => {
            banner.classList.remove('show');
        }, 3000);
    }
}

function hideNetworkStatus() {
    const banner = document.getElementById('network-status');
    if (banner) {
        banner.classList.remove('show');
    }
}

function getPendingSyncCount() {
    // Check localStorage for any pending items
    const pending = localStorage.getItem('pendingSyncs');
    if (pending) {
        try {
            return JSON.parse(pending).length;
        } catch (e) {
            return 0;
        }
    }
    return 0;
}

function addPendingSync(action, data) {
    if (!isOnline) {
        let pending = [];
        try {
            pending = JSON.parse(localStorage.getItem('pendingSyncs') || '[]');
        } catch (e) {
            pending = [];
        }
        pending.push({
            action: action,
            data: data,
            timestamp: Date.now()
        });
        localStorage.setItem('pendingSyncs', JSON.stringify(pending));
    }
}

function syncPendingChanges() {
    // In a real app, this would sync to a server
    // For this offline-first PWA, we just clear the pending queue
    // since all data is already saved in localStorage

    setTimeout(() => {
        localStorage.removeItem('pendingSyncs');
        showNetworkStatus('online', '✅ All changes synced!');
    }, 1500);
}

// Initialize Config immediately on load so dropdown is populated
initClassConfig();
restoreUISettings();
initDates();
initNetworkStatus();

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // Default true

function toggleSound() {
    soundEnabled = document.getElementById('sound-toggle').checked;
    localStorage.setItem('soundEnabled', soundEnabled);
    if (soundEnabled) {
        playTick(); // Play a test sound
    }
}

function playTick() {
    if (!soundEnabled) return;
    if (!audioCtx) initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
}

function playBuzz() {
    if (!soundEnabled) return;
    if (!audioCtx) initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
}

function initDates() {
    const options = { weekday: 'long', month: 'short', day: 'numeric' };
    const today = new Date();
    const dateString = today.toLocaleDateString('en-IN', options);
    document.getElementById('welcome-date').textContent = dateString;
    document.getElementById('app-date').textContent = dateString.toUpperCase();
}

function checkSubject() {
    const val = subjectInput.value.trim();
    const classSelector = document.getElementById('class-selector');
    const classSelected = classSelector && classSelector.value && classSelector.value !== '';
    const btn = document.getElementById('start-btn');

    if (val.length > 0 && classSelected) {
        btn.disabled = false;
        btn.style.opacity = "1";
    } else {
        btn.disabled = true;
        btn.style.opacity = "0.7";
    }
}

function startApp() {
    const subject = subjectInput.value.trim();
    if (!subject) {
        showToast("Please select a subject");
        return;
    }

    const classSelector = document.getElementById('class-selector');
    if (!classSelector || !classSelector.value) {
        showToast("Please select a class");
        return;
    }

    // Ensure class is loaded
    if (classSelector.value !== currentClassId) {
        currentClassId = classSelector.value;
        saveAllClasses();
        loadCurrentClass();
    }

    currentSubject = subject;
    localStorage.setItem('lastSubject', currentSubject);

    document.getElementById('app-subject-title').textContent = currentSubject;

    document.getElementById('welcome-screen').style.opacity = '0';
    document.getElementById('welcome-screen').style.visibility = 'hidden';

    const app = document.getElementById('app-interface');
    app.style.display = 'block';
    setTimeout(() => { app.style.opacity = '1'; }, 50);

    // Reset all students to PRESENT for new session
    students.forEach(s => {
        s.present = true;
        s.pinned = false;
    });

    renderStudents();
    updateStats();

    // Start Auto Save
    startAutoSave();

    // Init Audio Context on first interaction
    initAudio();

    showToast('✨ New session started - all present');
}

function getAvatar(name) { return name.charAt(0).toUpperCase(); }

function setFilterMode(mode) {
    currentFilter = mode;

    // UI Toggles
    const pillAll = document.getElementById('pill-all');
    const pillAbsent = document.getElementById('pill-absent');

    if (mode === 'all') {
        pillAll.className = 'view-pill active';
        pillAbsent.className = 'view-pill';
    } else {
        pillAll.className = 'view-pill';
        pillAbsent.className = 'view-pill active-absent';
    }

    filterStudents(); // Re-run filter logic
}

function renderStudents() {
    studentContainer.innerHTML = '';

    // Double check visibility based on filter
    let visibleCount = 0;

    // Create sortable list with original indices
    let displayList = students.map((s, i) => ({ ...s, originalIndex: i }));

    displayList.sort((a, b) => {
        // Pinned first
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return parseInt(a.roll) - parseInt(b.roll); // Default roll sort
    });

    displayList.forEach((student) => {
        if (!student.visible) return;
        if (currentFilter === 'absent' && student.present) return;

        visibleCount++;

        const originalIndex = student.originalIndex;
        const isFrequent = frequentAbsentees.has(student.roll.toString());
        const card = document.createElement('div');
        card.className = `student-card animate__animated animate__fadeInUp ${student.present ? 'present' : 'absent'} ${student.pinned ? 'pinned' : ''} ${isFrequent ? 'frequent-absent' : ''}`;
        card.style.animationDelay = `${visibleCount * 0.05}s`;
        card.dataset.studentIndex = originalIndex;

        // Event Listeners for Long Press & Click
        card.onclick = (e) => toggleAttendance(originalIndex, e);
        card.onmousedown = () => startLongPress(originalIndex, card);
        card.onmouseup = cancelLongPress;
        card.onmouseleave = cancelLongPress;
        card.ontouchstart = (e) => {
            startLongPress(originalIndex, card);
            handleSwipeStart(e, originalIndex, card);
        };
        card.ontouchmove = (e) => handleSwipeMove(e, card);
        card.ontouchend = (e) => {
            cancelLongPress();
            handleSwipeEnd(e, originalIndex, card);
        };
        card.oncontextmenu = (e) => { e.preventDefault(); return false; };

        card.innerHTML = `
            <div class="avatar">
                ${getAvatar(student.name)}
                <span class="roll-badge">${student.roll}</span>
            </div>
            <div class="student-info">
                <div class="student-name">
                    <span class="pinned-icon">📌</span>
                    ${student.name}
                </div>
                <div class="student-usn">
                    ${isFrequent ? '<span class="warn-icon" title="Frequently Absent">⚠️</span>' : ''}
                    ${student.usn}
                </div>
            </div>
            <div class="status-toggle">
                 <button style="background:transparent; border:none; margin-right:5px; cursor:pointer; opacity:0.5;" onclick="togglePin(${originalIndex}, event)">${student.pinned ? '⭐' : '☆'}</button>
                <button class="toggle-btn present-btn ${student.present ? 'active' : ''}" onclick="setAttendance(${originalIndex}, true, event)">✔</button>
                <button class="toggle-btn absent-btn ${!student.present ? 'active' : ''}" onclick="setAttendance(${originalIndex}, false, event)">✖</button>
            </div>
        `;
        studentContainer.appendChild(card);
    });

    if (visibleCount === 0 && currentFilter === 'absent') {
        studentContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--primary-teal);">
                <div style="font-size: 3rem; margin-bottom: 10px;">🎉</div>
                <h3>No absentees!</h3>
            </div>
        `;
    } else if (visibleCount === 0) {
        studentContainer.innerHTML = `<div style="text-align:center; padding: 20px; color: #999;">No students found</div>`;
    }
}

function setAttendance(index, isPresent, event) {
    if (event) event.stopPropagation();

    // Vibration & Sound Logic
    if (isPresent) {
        if (navigator.vibrate) navigator.vibrate(30);
        playTick();
    } else {
        if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
        playBuzz();
    }

    // Undo Stack
    const prev = students[index].present;
    if (prev !== isPresent) {
        actionStack.push({ index: index, status: prev });
    }

    students[index].present = isPresent;
    updateStats();

    // If in absent filter mode and marking present, need to hide card
    if (currentFilter === 'absent' && isPresent) {
        // Find and hide the card
        updateStudentCard(index);
    } else {
        // Just update the card visually for performance
        updateStudentCard(index);
    }

    triggerAutoSave();
}

function startLongPress(index, card) {
    cancelLongPress();
    pressTimer = setTimeout(() => {
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        card.classList.add('shaking');
        setAttendance(index, false); // Mark absent
        showToast("Marked Absent");
    }, 600); // 600ms hold
}

function cancelLongPress() {
    if (pressTimer) clearTimeout(pressTimer);
    pressTimer = null;
}

// --- Swipe Gesture Variables ---
let swipeStartX = 0;
let swipeStartY = 0;
let isSwiping = false;
let swipeThreshold = 80; // Minimum swipe distance in pixels

function handleSwipeStart(e, index, card) {
    if (e.touches && e.touches.length > 0) {
        swipeStartX = e.touches[0].clientX;
        swipeStartY = e.touches[0].clientY;
        isSwiping = false;
        card.style.transition = 'none';
    }
}

function handleSwipeMove(e, card) {
    if (!swipeStartX) return;

    const touch = e.touches[0];
    const deltaX = touch.clientX - swipeStartX;
    const deltaY = touch.clientY - swipeStartY;

    // Only handle horizontal swipes (ignore vertical scrolling)
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
        isSwiping = true;
        cancelLongPress(); // Cancel long press if swiping
        e.preventDefault(); // Prevent scrolling

        // Visual feedback - move card
        const maxMove = 100;
        const move = Math.max(-maxMove, Math.min(maxMove, deltaX));
        card.style.transform = `translateX(${move}px)`;

        // Color hint
        if (deltaX > swipeThreshold / 2) {
            card.style.background = 'rgba(16, 185, 129, 0.1)'; // Green hint (present)
        } else if (deltaX < -swipeThreshold / 2) {
            card.style.background = 'rgba(239, 68, 68, 0.1)'; // Red hint (absent)
        } else {
            card.style.background = '';
        }
    }
}

function handleSwipeEnd(e, index, card) {
    if (!swipeStartX) return;

    const touch = e.changedTouches[0];
    const deltaX = touch.clientX - swipeStartX;

    // Reset card position with animation
    card.style.transition = 'transform 0.3s ease, background 0.3s ease';
    card.style.transform = '';
    card.style.background = '';

    if (isSwiping && Math.abs(deltaX) >= swipeThreshold) {
        if (deltaX > 0) {
            // Swipe right = Present
            setAttendance(index, true);
            showToast('✓ Marked Present');
        } else {
            // Swipe left = Absent
            setAttendance(index, false);
            showToast('✗ Marked Absent');
        }
    }

    // Reset
    swipeStartX = 0;
    swipeStartY = 0;
    isSwiping = false;
}

function toggleAttendance(index, event) {
    if (event.target.tagName === 'BUTTON') return;
    if (isSwiping) return; // Don't toggle if was swiping
    // Short tap logic is handled here, but long press handles absent.
    // If click fires after long press (mouseup/touchend), we need to prevent toggle?
    // Usually the card click toggles state.
    // If we just marked absent via long press, toggling might switch it back to present.
    // How to prevent?
    // Simple check: if pressTimer fired, don't toggle? 
    // Actually, long press happens *before* click event usually finishes on touchend.
    // But let's assume standard behavior:

    // To simplify, we rely on setAttendance updating state.
    // If vibration happened, we consider it done.
    // However, native click will follow.

    const prev = students[index].present;

    // Standard toggle behavior updates
    if (navigator.vibrate) navigator.vibrate(30);
    playTick();

    actionStack.push({ index: index, status: prev });
    students[index].present = !students[index].present;
    updateStats();
    updateStudentCard(index);
    triggerAutoSave();
}

function updateStudentCard(index) {
    // Find the card for this student using data attribute - much faster
    const card = studentContainer.querySelector(`[data-student-index="${index}"]`);
    if (!card) return;

    const student = students[index];

    // Update card classes (remove animation classes to prevent re-animation)
    card.classList.remove('present', 'absent', 'animate__animated', 'animate__fadeInUp', 'shaking');
    card.classList.add(student.present ? 'present' : 'absent');

    // Update buttons
    const presentBtn = card.querySelector('.present-btn');
    const absentBtn = card.querySelector('.absent-btn');
    if (presentBtn) presentBtn.classList.toggle('active', student.present);
    if (absentBtn) absentBtn.classList.toggle('active', !student.present);

    // If in absent filter and now present, hide the card with animation
    if (currentFilter === 'absent' && student.present) {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => card.remove(), 200);
    }
}

function updateStats() {
    const total = students.length;
    const present = students.filter(s => s.present).length;
    const absent = total - present;
    const percentage = total === 0 ? 0 : Math.round((present / total) * 100);
    countPresentEl.textContent = present;
    countAbsentEl.textContent = absent;
    percentageEl.textContent = `${percentage}%`;
    const offset = circumference - (percentage / 100) * circumference;
    ringEl.style.strokeDashoffset = offset;

    strengthEl.textContent = `Total Class Strength: ${total}`;

    if (absent > 0) {
        bubbleEl.style.display = 'flex';
        bubbleEl.innerHTML = `<span>${absent}</span> Absentees <span style="font-size:0.8rem; margin-left:5px">⬇</span>`;
        bubbleEl.onclick = scrollToFirstAbsent;
    } else {
        bubbleEl.style.display = 'none';
    }
}

function scrollToFirstAbsent() {
    // Find first absent card
    const cards = document.querySelectorAll('.student-card.absent');
    if (cards.length > 0) {
        cards[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        showToast("Jumped to Absentee");
    } else {
        showToast("No absentees found");
    }
}

function calculateFrequentAbsentees() {
    frequentAbsentees.clear();
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const counts = {};
    history.forEach(session => {
        session.students.forEach(s => {
            // History stores status as boolean Present? 
            // Let's check structure.
            // Prior code: students: map(s => ({... status: s.present }))
            // So status=false is absent.
            if (!s.status) {
                const key = s.roll;
                counts[key] = (counts[key] || 0) + 1;
            }
        });
    });
    // Threshold > 1
    for (let [roll, count] of Object.entries(counts)) {
        if (count > 1) frequentAbsentees.add(roll.toString());
    }
}

function togglePin(index, event) {
    if (event) event.stopPropagation();
    students[index].pinned = !students[index].pinned;
    renderStudents();
    showToast(students[index].pinned ? "Student Pinned" : "Unpinned");
}

function undoLastAction() {
    if (actionStack.length === 0) {
        showToast("Nothing to undo");
        return;
    }
    const last = actionStack.pop();
    students[last.index].present = last.status;
    updateStats();
    renderStudents();
    showToast("Action Undone");

    // Hide settings after undo
    document.getElementById('settings-menu').classList.remove('open');
}

function toggleSettings() {
    const menu = document.getElementById('settings-menu');
    if (menu.classList.contains('open')) {
        closeSettingsMenu();
    } else {
        menu.classList.add('open');
        // Add click outside listener after a small delay to prevent immediate close
        setTimeout(() => {
            document.addEventListener('click', handleSettingsClickOutside);
        }, 10);
    }
}

function closeSettingsMenu() {
    const menu = document.getElementById('settings-menu');
    menu.classList.remove('open');
    document.removeEventListener('click', handleSettingsClickOutside);
}

function handleSettingsClickOutside(e) {
    const menu = document.getElementById('settings-menu');
    const settingsBtn = document.querySelector('[onclick="toggleSettings()"]');
    if (!menu.contains(e.target) && !settingsBtn.contains(e.target)) {
        closeSettingsMenu();
    }
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

function toggleBatterySaver() {
    document.body.classList.toggle('battery-saver');
    localStorage.setItem('batterySaver', document.body.classList.contains('battery-saver'));
}

function markAll(present) {
    const action = present ? 'Present' : 'Absent';
    const confirmMsg = `Are you sure you want to mark all ${students.length} students as ${action}?`;

    if (!confirm(confirmMsg)) {
        return;
    }

    students.forEach(s => {
        // Only affect visible if searching? usually mark all implies all displayed or all total. 
        // Standard behavior is usually all visible students or all total. 
        // For safety in this simpler app, we mark ALL so data is consistent.
        s.present = present;
    });
    renderStudents();
    updateStats();
    showToast(present ? "Marked All Present" : "Marked All Absent");
    triggerAutoSave();
}

let currentSort = 'roll';
let sortAscending = true;

function sortStudents(sortBy) {
    // Toggle direction if same sort key
    if (currentSort === sortBy) {
        sortAscending = !sortAscending;
    } else {
        currentSort = sortBy;
        sortAscending = true;
    }

    // Update UI buttons
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`sort-${sortBy}`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        // Update arrow direction
        const svg = activeBtn.querySelector('svg');
        if (svg) {
            svg.style.transform = sortAscending ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }

    // Sort the students array
    students.sort((a, b) => {
        let comparison = 0;

        switch (sortBy) {
            case 'roll':
                comparison = parseInt(a.roll) - parseInt(b.roll);
                break;
            case 'name':
                comparison = (a.name || '').localeCompare(b.name || '');
                break;
            case 'status':
                // Present first when ascending, absent first when descending
                comparison = (b.present ? 1 : 0) - (a.present ? 1 : 0);
                break;
        }

        return sortAscending ? comparison : -comparison;
    });

    // Update originalIndex after sorting
    students.forEach((s, i) => s.originalIndex = i);

    renderStudents();
    showToast(`Sorted by ${sortBy} ${sortAscending ? '↑' : '↓'}`);
}

function filterStudents() {
    const query = document.getElementById('search-input').value.trim().toLowerCase();

    if (!query) {
        // No query - show all
        students.forEach(student => student.visible = true);
    } else {
        students.forEach(student => {
            const name = (student.name || '').toLowerCase();
            const roll = (student.roll || '').toString().toLowerCase();
            const usn = (student.usn || '').toLowerCase();

            // Priority 1: Exact match on roll or USN
            if (roll === query || usn === query) {
                student.visible = true;
                return;
            }

            // Priority 2: Roll starts with query (for roll number search)
            if (roll.startsWith(query)) {
                student.visible = true;
                return;
            }

            // Priority 3: USN contains query (must be at least 3 chars)
            if (query.length >= 3 && usn.includes(query)) {
                student.visible = true;
                return;
            }

            // Priority 4: Name starts with query
            if (name.startsWith(query)) {
                student.visible = true;
                return;
            }

            // Priority 5: Any word in name starts with query
            const nameWords = name.split(/\s+/);
            for (const word of nameWords) {
                if (word.startsWith(query)) {
                    student.visible = true;
                    return;
                }
            }

            // Priority 6: Fuzzy match only if query is 4+ chars (stricter)
            if (query.length >= 4) {
                for (const word of nameWords) {
                    if (word.length >= 3 && similarityScore(word, query) >= 0.8) {
                        student.visible = true;
                        return;
                    }
                }
            }

            student.visible = false;
        });
    }
    renderStudents();
}

function toggleHistory() {
    const view = document.getElementById('history-view');
    if (view.style.display === 'block') {
        view.style.display = 'none';
    } else {
        // Clear search when opening
        const searchInput = document.getElementById('history-search');
        if (searchInput) searchInput.value = '';
        renderHistoryList();
        view.style.display = 'block';
    }
}

function filterHistory() {
    renderHistoryList();
}

function clearHistorySearch() {
    const searchInput = document.getElementById('history-search');
    if (searchInput) searchInput.value = '';
    renderHistoryList();
}

function toggleAbout() {
    const modal = document.getElementById('about-modal');
    if (modal.style.display === 'flex') {
        modal.style.opacity = '0';
        setTimeout(() => modal.style.display = 'none', 300);
    } else {
        modal.style.display = 'flex';
        requestAnimationFrame(() => modal.style.opacity = '1');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Don't trigger shortcuts when typing in input fields
    const activeEl = document.activeElement;
    const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);

    if (e.key === 'Escape') {
        const aboutModal = document.getElementById('about-modal');
        if (aboutModal.style.display === 'flex') toggleAbout();
        const settingsMenu = document.getElementById('settings-menu');
        if (settingsMenu.classList.contains('open')) closeSettingsMenu();
    }

    // Keyboard shortcuts only when not typing and not in history mode
    if (!isTyping && !viewHistoryMode && students.length > 0) {
        if (e.key.toLowerCase() === 'p' && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault();
            markAll(true); // Mark all present
        } else if (e.key.toLowerCase() === 'a' && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault();
            markAll(false); // Mark all absent
        } else if (e.key.toLowerCase() === 'z' && e.ctrlKey && !e.shiftKey) {
            e.preventDefault();
            undoLastAction(); // Ctrl+Z to undo
        } else if (e.key.toLowerCase() === 's' && e.ctrlKey) {
            e.preventDefault();
            saveAttendanceRecord(); // Ctrl+S to save
            showToast('💾 Attendance saved!');
        } else if (e.key.toLowerCase() === 'f' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('search-input').focus(); // Ctrl+F to focus search
        }
    }
});

// Save draft before page unload to prevent data loss
window.addEventListener('beforeunload', function (e) {
    // Don't save if user clicked Home button
    if (window.goingHome) {
        return;
    }

    console.log('🔄 beforeunload - saving draft...', {
        students: students.length,
        currentSubject: currentSubject,
        appVisible: document.getElementById('app-interface').style.display
    });

    // Save current session as draft if there are students and subject set
    if (students.length > 0 && currentSubject) {
        // Force save draft
        const draft = {
            subject: currentSubject,
            date: getFormattedDate(),
            students: students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, status: s.present, pinned: s.pinned })),
            presentCount: students.filter(s => s.present).length,
            absentCount: students.filter(s => !s.present).length,
            percentage: Math.round((students.filter(s => s.present).length / students.length) * 100),
            lastSaved: Date.now()
        };
        localStorage.setItem('attendanceDraft', JSON.stringify(draft));
        console.log('✅ Draft saved on unload');
    }
    // Also save multi-class state
    saveAllClasses();
});

// Also save when tab becomes hidden (user switches tabs)
document.addEventListener('visibilitychange', function () {
    if (document.hidden && students.length > 0 && currentSubject) {
        saveDraft();
        saveAllClasses();
    }
});

function saveAttendanceRecord() {
    if (viewHistoryMode) return;
    const formattedDate = getFormattedDate();
    const displayDate = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const total = students.length;
    const present = students.filter(s => s.present).length;
    const absent = total - present;
    const percentage = Math.round((present / total) * 100);

    // Get session notes
    const notesInput = document.getElementById('session-notes');
    const notes = notesInput ? notesInput.value.trim() : '';

    const record = {
        id: Date.now().toString(),
        date: formattedDate,
        displayDate: displayDate,
        subject: currentSubject,
        presentCount: present,
        absentCount: absent,
        percentage: percentage,
        notes: notes, // Teacher notes for this session
        students: students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, status: s.present }))
    };

    let history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    history = history.filter(r => !(r.date === formattedDate && r.subject === currentSubject));
    history.unshift(record);
    localStorage.setItem('attendanceHistory', JSON.stringify(history));
}

function manualSave() {
    saveAttendanceRecord();
    // Clear session notes after saving
    const notesInput = document.getElementById('session-notes');
    if (notesInput) notesInput.value = '';
    showToast('Attendance saved to history!');
}

// Levenshtein distance - calculates minimum edits needed to transform one string to another
function levenshtein(a, b) {
    if (!a.length) return b.length;
    if (!b.length) return a.length;

    const matrix = [];
    for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
    }
    for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
    }

    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b[i - 1] === a[j - 1]) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1, // substitution
                    matrix[i][j - 1] + 1,   // insertion
                    matrix[i - 1][j] + 1    // deletion
                );
            }
        }
    }
    return matrix[b.length][a.length];
}

// Calculate similarity score (0-1) based on Levenshtein distance
function similarityScore(str1, str2) {
    if (!str1 || !str2) return 0;
    str1 = str1.toLowerCase();
    str2 = str2.toLowerCase();

    if (str1 === str2) return 1;
    if (str1.includes(str2) || str2.includes(str1)) return 0.95;

    const maxLen = Math.max(str1.length, str2.length);
    if (maxLen === 0) return 1;

    const distance = levenshtein(str1, str2);
    return 1 - (distance / maxLen);
}

// Advanced fuzzy search with multiple strategies
function fuzzySearch(text, query) {
    if (!text || !query) return false;
    text = text.toLowerCase();
    query = query.toLowerCase().trim();

    // Strategy 1: Direct contains (fastest)
    if (text.includes(query)) return true;

    // Strategy 2: Word starts with query
    const words = text.split(/[\s,\-\/\.]+/).filter(w => w.length > 0);
    for (const word of words) {
        if (word.startsWith(query)) return true;
    }

    // Strategy 3: Query words all found (for multi-word queries)
    const queryWords = query.split(/\s+/).filter(w => w.length > 0);
    if (queryWords.length > 1) {
        const allFound = queryWords.every(qw =>
            words.some(w => w.includes(qw) || similarityScore(w, qw) >= 0.6)
        );
        if (allFound) return true;
    }

    // Strategy 4: Levenshtein similarity for typo tolerance
    for (const word of words) {
        // Allow more typos for longer words
        const threshold = word.length <= 4 ? 0.7 : 0.6;
        if (similarityScore(word, query) >= threshold) return true;

        // Also check if query is similar to start of word
        if (word.length > query.length) {
            const wordStart = word.substring(0, query.length + 1);
            if (similarityScore(wordStart, query) >= 0.75) return true;
        }
    }

    // Strategy 5: Character sequence matching (for abbreviations like "ee" -> "Electrical Engineering")
    if (query.length >= 2 && query.length <= 4) {
        let queryIdx = 0;
        for (const word of words) {
            if (queryIdx < query.length && word[0] === query[queryIdx]) {
                queryIdx++;
            }
        }
        if (queryIdx === query.length) return true;
    }

    // Strategy 6: Substring in any word with 1 char tolerance
    for (const word of words) {
        if (word.length >= query.length - 1) {
            for (let i = 0; i <= word.length - query.length + 1; i++) {
                const substr = word.substring(i, i + query.length);
                if (similarityScore(substr, query) >= 0.8) return true;
            }
        }
    }

    return false;
}

function renderHistoryList() {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const list = document.getElementById('history-list');
    const searchInput = document.getElementById('history-search');
    const query = searchInput ? searchInput.value.trim() : '';

    list.innerHTML = '';

    if (history.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">No attendance records found.</p>';
        return;
    }

    // Filter history based on fuzzy search query
    const filteredHistory = query ? history.filter(record => {
        const searchText = `${record.displayDate || ''} ${record.subject || ''} ${record.date || ''}`;
        return fuzzySearch(searchText, query);
    }) : history;

    if (filteredHistory.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">No records match your search.</p>';
        return;
    }

    filteredHistory.forEach(record => {
        const card = document.createElement('div');
        card.className = 'history-card';

        // Notes badge if notes exist
        const notesBadge = record.notes ?
            `<div class="notes-badge" onclick="showSessionNotes('${record.id || record.date}')" title="View notes">📝 ${record.notes.length > 25 ? record.notes.substring(0, 25) + '...' : record.notes}</div>` : '';

        card.innerHTML = `
            <div class="h-card-header">
                <span class="h-date">${record.displayDate}</span>
                <span style="font-weight: bold; color: ${record.percentage >= 75 ? 'green' : 'orange'}">${record.percentage}%</span>
            </div>
            <div class="h-subject">${record.subject || 'Unknown Subject'}</div>
            <div class="h-stats">
                Present: ${record.presentCount} &bull; Absent: ${record.absentCount}
            </div>
            ${notesBadge}
            <div class="h-actions">
                <button class="h-btn primary" onclick="loadHistoryRecord('${record.id || record.date}')">📂 Open</button>
                <button class="h-btn" onclick="downloadHistoryPDF('${record.id || record.date}')">📄 PDF</button>
                <button class="h-btn" style="background:#10B981; color:white; border:none;" onclick="downloadHistoryExcel('${record.id || record.date}')">📊 XLS</button>
            </div>
        `;
        list.appendChild(card);
    });
}

function showSessionNotes(identifier) {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const record = history.find(r => r.id === identifier || r.date === identifier);

    if (record && record.notes) {
        // Create modal to show notes
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.id = 'notes-modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="edit-modal-content animate__animated animate__fadeInUp" style="max-width: 400px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">📝 Session Notes</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 15px 0;">
                    ${record.subject} - ${record.displayDate}
                </p>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; color: #92400e; white-space: pre-wrap; text-align: left;">
                    ${record.notes}
                </div>
                <div class="edit-modal-actions" style="margin-top: 20px;">
                    <button class="edit-save" onclick="closeNotesModal()">Close</button>
                </div>
            </div>
        `;
        modal.onclick = (e) => { if (e.target === modal) closeNotesModal(); };
        document.body.appendChild(modal);
    }
}

function closeNotesModal() {
    const modal = document.getElementById('notes-modal');
    if (modal) modal.remove();
}

function loadHistoryRecord(identifier) {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const record = history.find(r => r.id === identifier || r.date === identifier);

    if (record) {
        students = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status, visible: true }));
        viewHistoryMode = true;
        currentRecordDate = record.date;
        currentSubject = record.subject || "Restored Session";

        document.getElementById('app-subject-title').textContent = currentSubject;

        // Reset filter to ALL when loading history
        setFilterMode('all');
        document.getElementById('search-input').value = '';

        updateStats();
        renderStudents(); // Explicit render called by setFilterMode above actually

        document.getElementById('history-view').style.display = 'none';
        document.getElementById('history-banner').style.display = 'block';
        document.getElementById('app-date').textContent = record.displayDate.toUpperCase();

        showToast("Loaded: " + currentSubject);
    }
}

function exitHistoryMode() {
    viewHistoryMode = false;
    currentRecordDate = null;
    location.reload();
}

function goToHome() {
    // Clear the draft so it doesn't auto-restore
    localStorage.removeItem('attendanceDraft');

    // Set a flag to prevent beforeunload from saving draft
    window.goingHome = true;

    // Hide app interface, show welcome screen
    document.getElementById('app-interface').style.display = 'none';
    document.getElementById('app-interface').style.opacity = '0';

    const welcome = document.getElementById('welcome-screen');
    welcome.style.visibility = 'visible';
    welcome.style.opacity = '1';

    // Stop auto-save
    stopAutoSave();

    // Reset subject selection
    currentSubject = null;
    document.getElementById('subject-input').selectedIndex = 0;

    // Reset class selector to show "Select Class"
    renderClassSelector();

    showToast('🏠 Returned to home');
}

// --- Backup & Restore ---

function backupData() {
    const data = {
        history: localStorage.getItem('attendanceHistory'),
        draft: localStorage.getItem('attendanceDraft'),
        darkMode: localStorage.getItem('darkMode'),
        batterySaver: localStorage.getItem('batterySaver'),
        lastSubject: localStorage.getItem('lastSubject'),
        classConfig: localStorage.getItem('classConfig'),
        timestamp: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_backup_${getFormattedDate()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast("Backup Downloaded");
}

function triggerRestore() {
    document.getElementById('restore-input').click();
}

function restoreData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.history) localStorage.setItem('attendanceHistory', data.history);
            if (data.draft) localStorage.setItem('attendanceDraft', data.draft);
            if (data.darkMode) localStorage.setItem('darkMode', data.darkMode);
            if (data.batterySaver) localStorage.setItem('batterySaver', data.batterySaver);
            if (data.lastSubject) localStorage.setItem('lastSubject', data.lastSubject);
            if (data.classConfig) localStorage.setItem('classConfig', data.classConfig);

            showToast("Data Restored Successfully");
            setTimeout(() => location.reload(), 1500);
        } catch (err) {
            showToast("Invalid Backup File");
            console.error(err);
        }
    };
    reader.readAsText(file);
}

function clearHistory() {
    if (confirm('Are you sure you want to delete ALL history?')) {
        localStorage.removeItem('attendanceHistory');
        renderHistoryList();
        showToast("History Cleared");
    }
}

// --- Auto Save & Restore Logic ---

function startAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
        saveDraft();
    }, 10000); // 10 seconds
}

function stopAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
}

function triggerAutoSave() {
    saveDraft();

    // Track as pending sync if offline
    if (!isOnline) {
        addPendingSync('attendance_draft', { timestamp: Date.now() });
    }

    // Reset timer to avoid double save
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
        saveDraft();
    }, 10000);
}

function saveDraft() {
    if (viewHistoryMode) return; // Don't save history views as drafts
    if (!currentSubject) return;

    const total = students.length;
    const present = students.filter(s => s.present).length;
    const absent = total - present;
    const percentage = total === 0 ? 0 : Math.round((present / total) * 100);

    const draft = {
        subject: currentSubject,
        date: getFormattedDate(),
        students: students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, status: s.present, pinned: s.pinned })),
        presentCount: present,
        absentCount: absent,
        percentage: percentage,
        lastSaved: Date.now()
    };

    localStorage.setItem('attendanceDraft', JSON.stringify(draft));
    showAutoSaveIndicator();
}

function showAutoSaveIndicator() {
    const el = document.getElementById('auto-save-msg');
    const now = new Date();
    el.textContent = `Saved ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    el.style.opacity = '1';
    setTimeout(() => { el.style.opacity = '0'; }, 3000);
}

function checkForDrafts() {
    const draft = localStorage.getItem('attendanceDraft');
    console.log('🔍 Checking for drafts:', draft ? 'found' : 'none');

    if (draft) {
        const data = JSON.parse(draft);
        const draftDate = new Date(data.lastSaved);
        const now = new Date();

        // Auto-restore if draft is from same day (less than 12 hours old)
        const hoursDiff = (now - draftDate) / (1000 * 60 * 60);
        console.log('📋 Draft age:', hoursDiff.toFixed(2), 'hours, students:', data.students?.length);

        if (hoursDiff < 12) {
            // Auto-restore recent draft
            console.log('✅ Auto-restoring draft...');
            restoreDraft();
            showToast('📋 Session auto-restored');
        } else {
            // Ask for older drafts
            document.getElementById('draft-time').textContent = draftDate.toLocaleString();
            document.getElementById('restore-modal').style.display = 'flex';
        }
    }
}

function discardDraft() {
    localStorage.removeItem('attendanceDraft');
    document.getElementById('restore-modal').style.display = 'none';
}

function restoreDraft() {
    const draft = JSON.parse(localStorage.getItem('attendanceDraft'));
    if (!draft) return;

    // Load data
    currentSubject = draft.subject;
    localStorage.setItem('lastSubject', currentSubject);

    // Restore students directly from draft (not merging with empty array)
    if (draft.students && draft.students.length > 0) {
        students = draft.students.map(s => ({
            roll: s.roll,
            name: s.name,
            usn: s.usn || 'Unknown',
            present: s.status,
            visible: true,
            pinned: s.pinned || false
        }));
    } else {
        // Fallback: merge with existing students if draft doesn't have full data
        students.forEach(s => {
            const draftStudent = draft.students.find(ds => ds.roll === s.roll || ds.name === s.name);
            if (draftStudent) {
                s.present = draftStudent.status;
                s.pinned = draftStudent.pinned || false;
            }
        });
    }

    // UI Setup
    document.getElementById('app-subject-title').textContent = currentSubject;
    document.getElementById('welcome-screen').style.opacity = '0';
    document.getElementById('welcome-screen').style.visibility = 'hidden';

    const app = document.getElementById('app-interface');
    app.style.display = 'block';
    setTimeout(() => { app.style.opacity = '1'; }, 50);

    renderStudents();
    updateStats();
    document.getElementById('restore-modal').style.display = 'none';
    showToast("Draft Restored");

    startAutoSave();
}

function clearDraft() {
    localStorage.removeItem('attendanceDraft');
    stopAutoSave();
}

// Note: Update resetApp and download functions to clear draft

function downloadHistoryPDF(identifier) {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const record = history.find(r => r.id === identifier || r.date === identifier);
    if (record) {
        const recordStudents = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status }));
        // We use generateAbsenteePDF for history PDF as per requirement, or we could add generateFullPDF for history.
        // Reusing GenerateAbsenteePDF logic for history items as it seems to handle customStudents.
        // But wait, the user might want full list. The requirement says "Clicking exports Excel for that saved date".
        // For PDF, existing behavior was "generateAbsenteePDF".
        generateAbsenteePDF(recordStudents, record.date, record.subject, true, record.notes);
    }
}

function downloadHistoryExcel(identifier) {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const record = history.find(r => r.id === identifier || r.date === identifier);
    if (record) {
        const recordStudents = record.students.map(s => ({ roll: s.roll, name: s.name, usn: s.usn, present: s.status }));
        generateExcel(recordStudents, record.date, record.subject, true);
    }
}

function resetApp() {
    if (viewHistoryMode) {
        if (confirm('Exit view mode?')) location.reload();
        return;
    }
    if (confirm('Finish session and save?')) {
        saveAttendanceRecord();
        clearDraft();
        showSummaryScreen();
    }
}

function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.innerHTML = `<span>${msg}</span>`;
    toast.className = 'toast show';
    setTimeout(() => { toast.className = 'toast'; }, 2000);
}

function showSummaryScreen() {
    const total = students.length;
    const present = students.filter(s => s.present).length;
    const absent = total - present;
    const percentage = total === 0 ? 0 : Math.round((present / total) * 100);

    document.getElementById('summary-subject').textContent = currentSubject;
    document.getElementById('summary-date').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('sum-present').textContent = present;
    document.getElementById('sum-absent').textContent = absent;
    document.getElementById('sum-percentage').textContent = percentage + '%';

    // Set icon based on attendance
    const icon = document.getElementById('summary-icon');
    if (percentage >= 90) {
        icon.textContent = '🎉';
    } else if (percentage >= 75) {
        icon.textContent = '✅';
    } else if (percentage >= 50) {
        icon.textContent = '⚠️';
    } else {
        icon.textContent = '❌';
    }

    // Find top absentee from history
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const absenceCounts = {};
    history.forEach(session => {
        session.students.forEach(s => {
            if (!s.status) {
                const key = s.name;
                absenceCounts[key] = absenceCounts[key] || { count: 0, usn: s.usn, roll: s.roll };
                absenceCounts[key].count++;
            }
        });
    });

    let topAbsentee = null;
    let maxCount = 0;
    for (const [name, data] of Object.entries(absenceCounts)) {
        if (data.count > maxCount) {
            maxCount = data.count;
            topAbsentee = { name, ...data };
        }
    }

    if (topAbsentee) {
        document.getElementById('ta-name').textContent = topAbsentee.name;
        document.getElementById('ta-desc').textContent = `USN: ${topAbsentee.usn} • Total Absences: ${topAbsentee.count}`;
    } else {
        document.getElementById('ta-name').textContent = 'No data';
        document.getElementById('ta-desc').textContent = 'Not enough history to determine';
    }

    // Show summary screen
    document.getElementById('summary-screen').style.display = 'flex';

    // Create confetti effect
    createConfetti();
}

function showLoading(text = 'Generating...') {
    const overlay = document.getElementById('loading-overlay');
    overlay.querySelector('.loading-text').textContent = text;
    overlay.classList.add('show');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('show');
}

function createConfetti() {
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    const colors = ['#FF6B35', '#004E89', '#F7B32B', '#2EC4B6', '#10B981'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: absolute;
            width: ${Math.random() * 10 + 5}px;
            height: ${Math.random() * 10 + 5}px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}%;
            top: -20px;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            animation: confetti-fall ${Math.random() * 3 + 2}s linear forwards;
        `;
        container.appendChild(confetti);
    }
}

function goHome() {
    document.getElementById('summary-screen').style.display = 'none';
    location.reload();
}

function getFormattedDate(dateObj = new Date()) {
    return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
}

async function generateAbsenteePDF(customStudents = null, customDateString = null, customSubject = null, isReprint = false, sessionNotes = null) {
    showLoading('Generating PDF...');

    // Small delay to show loading state
    await new Promise(resolve => setTimeout(resolve, 100));

    try {
        const targetStudents = customStudents || students;
        const targetSubject = customSubject || currentSubject;
        const notes = sessionNotes || (document.getElementById('session-notes') ? document.getElementById('session-notes').value.trim() : '');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont("times", "bold");
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text("LIST OF ABSENTEES", pageWidth / 2, 20, null, null, "center");

        doc.setLineWidth(0.5);
        doc.line(20, 25, pageWidth - 20, 25);

        doc.setFont("times", "normal");
        doc.setFontSize(11);

        let displayDate = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        if (customDateString) {
            displayDate = new Date(customDateString).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        doc.text(`Subject: ${targetSubject}`, 14, 35);
        doc.text(`Date: ${displayDate}`, 14, 42);

        // Add notes if present
        let tableStartY = 50;
        if (notes) {
            doc.setFont("times", "italic");
            doc.setFontSize(10);
            doc.text(`Notes: ${notes}`, 14, 49);
            tableStartY = 56;
        }

        const absentStudents = targetStudents.filter(s => !s.present);

        if (absentStudents.length === 0) {
            doc.setFont("times", "italic");
            doc.text("Nil (No Absentees)", 14, tableStartY + 5);
        } else {
            const tableData = absentStudents.map((s, index) => [(index + 1).toString(), s.roll, s.usn, s.name]);

            doc.autoTable({
                head: [['S.No', 'Roll', 'USN', 'Student Name']],
                body: tableData,
                startY: tableStartY,
                theme: 'plain',
                styles: { font: 'times', fontSize: 10, cellPadding: 4, lineColor: [0, 0, 0], lineWidth: 0.1, textColor: [0, 0, 0] },
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [0, 0, 0] },
                columnStyles: { 0: { cellWidth: 15, halign: 'center' }, 1: { cellWidth: 20 }, 2: { cellWidth: 40 }, 3: { cellWidth: 'auto' } }
            });
        }

        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 60;
        doc.setFont("times", "normal");
        doc.setFontSize(10);
        doc.text("Faculty Signature", pageWidth - 50, finalY + 30, null, null, "center");

        const safeSub = targetSubject.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
        const fname = customDateString ? `Attendance_${safeSub}_${customDateString}.pdf` : `Attendance_${safeSub}_${getFormattedDate()}.pdf`;

        doc.save(fname);
        hideLoading();

        if (!customStudents) {
            if (!isReprint) {
                saveAttendanceRecord();
                clearDraft();
            }
            showSummaryScreen();
            showToast("Saved & Downloaded");
        } else {
            showToast("History Downloaded");
        }
    } catch (error) {
        hideLoading();
        console.error('PDF generation error:', error);
        showToast("❌ Failed to generate PDF");
    }
}

async function generateFullPDF() {
    showLoading('Generating PDF...');

    // Small delay to show loading state
    await new Promise(resolve => setTimeout(resolve, 100));

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont("times", "bold");
        doc.setFontSize(16);
        doc.text("ATTENDANCE REGISTER", pageWidth / 2, 20, null, null, "center");

        doc.setFont("times", "normal");
        doc.setFontSize(11);
        doc.text(`Subject: ${currentSubject}`, 14, 30);
        doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 14, 37);

        const tableData = students.map(s => [s.roll, s.usn, s.name, s.present ? 'P' : 'A']);

        doc.autoTable({
            head: [['Roll', 'USN', 'Name', 'Status']],
            body: tableData,
            startY: 45,
            theme: 'grid',
            styles: { font: 'times', fontSize: 9 },
            headStyles: { fillColor: [220, 220, 220], textColor: 0 },
            didParseCell: function (data) {
                if (data.section === 'body' && data.column.index === 3) {
                    data.cell.styles.textColor = data.cell.raw === 'A' ? [255, 0, 0] : [0, 128, 0];
                }
            }
        });

        const safeSub = currentSubject.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
        doc.save(`Full_Attendance_${safeSub}_${getFormattedDate()}.pdf`);
        hideLoading();
        saveAttendanceRecord();
        clearDraft();
        showSummaryScreen();
        showToast("Saved & Downloaded");
    } catch (error) {
        hideLoading();
        console.error('PDF generation error:', error);
        showToast("❌ Failed to generate PDF");
    }
}

function copyTextReport() {
    const dateStr = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
    const absentList = students.filter(s => !s.present);
    let text = `Attendance Report - ${currentSubject} (${dateStr})\n`;
    text += `Total: ${students.length} | Present: ${students.filter(s => s.present).length} | Absent: ${absentList.length}\n\n`;
    if (absentList.length === 0) { text += "All Present."; }
    else { text += "Absentees:\n"; absentList.forEach(s => { text += `[${s.roll}]${s.pinned ? '⭐' : ''} ${s.name} (${s.usn})\n`; }); }
    navigator.clipboard.writeText(text).then(() => { showToast("📋 Copied to clipboard!"); }).catch(err => { showToast("❌ Failed to copy"); });
}

function shareToWhatsApp() {
    const dateStr = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
    const absentList = students.filter(s => !s.present);
    let text = `*Attendance Report - ${currentSubject} (${dateStr})*\n`;
    text += `Total: ${students.length} | Present: ${students.filter(s => s.present).length} | Absent: ${absentList.length}\n\n`;

    if (absentList.length === 0) {
        text += "All Present. 🎉";
    } else {
        text += "*Absentees:*\n";
        absentList.forEach(s => {
            text += `• ${s.name} (${s.roll})\n`;
        });
    }

    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

async function generateExcel(customStudents = null, customDateString = null, customSubject = null, isReprint = false) {
    showLoading('Generating Excel...');

    // Small delay to show loading state
    await new Promise(resolve => setTimeout(resolve, 100));

    try {
        const targetStudents = customStudents || students;
        const targetSubject = customSubject || currentSubject;
        const dateStr = customDateString || getFormattedDate();

        if (!targetStudents || targetStudents.length === 0) {
            hideLoading();
            showToast("No data to export");
            return;
        }

        // Prepare Data for SheetJS
        // Format: Roll | USN | Name | Status | Subject | Date
        const data = targetStudents.map(s => ({
            "Roll": s.roll,
            "USN": s.usn,
            "Name": s.name,
            "Status": s.present ? "Present" : "Absent",
            "Subject": targetSubject,
            "Date": dateStr
        }));

        // Create Worksheet
        const ws = XLSX.utils.json_to_sheet(data);

        // Create Workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Attendance");

        // Generate Filename
        const safeSub = targetSubject.replace(/[^a-z0-9]/gi, '');
        const filename = `Attendance_${safeSub}_${dateStr}.xlsx`;

        // Download
        XLSX.writeFile(wb, filename);
        hideLoading();

        showToast("Excel Downloaded Successfully");
    } catch (error) {
        hideLoading();
        console.error('Excel generation error:', error);
        showToast("❌ Failed to generate Excel");
    }
}

// --- Manager Functions ---

function openManageModal() {
    document.getElementById('manage-modal').style.display = 'flex';
    document.getElementById('settings-menu').classList.remove('open'); // Close settings
    switchManageTab('students');
}

function closeManageModal() {
    document.getElementById('manage-modal').style.display = 'none';
}

// --- Monthly Reports Functions ---

function openMonthlyReport() {
    document.getElementById('reports-modal').style.display = 'flex';
    document.getElementById('settings-menu').classList.remove('open');
    populateReportSelectors();
}

function closeReportsModal() {
    document.getElementById('reports-modal').style.display = 'none';
}

function populateReportSelectors() {
    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
    const monthSelect = document.getElementById('report-month');
    const yearSelect = document.getElementById('report-year');

    // Get unique years from history
    const years = new Set();
    const currentYear = new Date().getFullYear();
    years.add(currentYear);

    history.forEach(record => {
        if (record.date) {
            const year = new Date(record.date).getFullYear();
            if (!isNaN(year)) years.add(year);
        }
    });

    // Populate years
    yearSelect.innerHTML = '';
    Array.from(years).sort((a, b) => b - a).forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        yearSelect.appendChild(opt);
    });

    // Populate months
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    monthSelect.innerHTML = '<option value="">Select Month</option>';
    months.forEach((month, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = month;
        monthSelect.appendChild(opt);
    });

    // Set current month
    monthSelect.value = new Date().getMonth();
    generateMonthlyReport();
}

function generateMonthlyReport() {
    const monthSelect = document.getElementById('report-month');
    const yearSelect = document.getElementById('report-year');
    const content = document.getElementById('report-content');

    const month = parseInt(monthSelect.value);
    const year = parseInt(yearSelect.value);

    if (isNaN(month)) {
        content.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">Select a month to view the report</p>';
        return;
    }

    const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');

    // Filter records for selected month/year
    const monthRecords = history.filter(record => {
        if (!record.date) return false;
        const d = new Date(record.date);
        return d.getMonth() === month && d.getFullYear() === year;
    });

    if (monthRecords.length === 0) {
        content.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">No attendance records for this month</p>';
        return;
    }

    // Calculate statistics
    const totalSessions = monthRecords.length;
    let totalPresent = 0;
    let totalAbsent = 0;
    const subjectStats = {};
    const dailyStats = {};
    const studentAbsences = {};

    monthRecords.forEach(record => {
        totalPresent += record.presentCount || 0;
        totalAbsent += record.absentCount || 0;

        // Subject stats
        const subj = record.subject || 'Unknown';
        if (!subjectStats[subj]) {
            subjectStats[subj] = { sessions: 0, present: 0, absent: 0 };
        }
        subjectStats[subj].sessions++;
        subjectStats[subj].present += record.presentCount || 0;
        subjectStats[subj].absent += record.absentCount || 0;

        // Daily stats
        const day = new Date(record.date).getDate();
        if (!dailyStats[day]) {
            dailyStats[day] = { present: 0, absent: 0, sessions: 0 };
        }
        dailyStats[day].present += record.presentCount || 0;
        dailyStats[day].absent += record.absentCount || 0;
        dailyStats[day].sessions++;

        // Track student absences
        if (record.students) {
            record.students.forEach(s => {
                if (!s.status) { // absent
                    const key = s.roll + '-' + s.name;
                    studentAbsences[key] = (studentAbsences[key] || 0) + 1;
                }
            });
        }
    });

    const avgAttendance = totalPresent + totalAbsent > 0
        ? Math.round((totalPresent / (totalPresent + totalAbsent)) * 100)
        : 0;

    // Generate HTML
    let html = `
        <div style="background: linear-gradient(135deg, var(--primary-blue), var(--primary-teal)); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="font-size: 2rem; font-weight: 700;">${avgAttendance}%</div>
            <div style="opacity: 0.9;">Average Attendance</div>
            <div style="display: flex; justify-content: space-around; margin-top: 15px; font-size: 0.9rem;">
                <div><strong>${totalSessions}</strong><br>Sessions</div>
                <div><strong>${totalPresent}</strong><br>Present</div>
                <div><strong>${totalAbsent}</strong><br>Absent</div>
            </div>
        </div>
        
        <!-- Subject-wise Chart -->
        <h4 style="margin-bottom: 10px; color: var(--text-dark);">📚 Subject-wise Attendance</h4>
        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
    `;

    // Subject bars
    Object.entries(subjectStats).forEach(([subject, stats]) => {
        const pct = stats.present + stats.absent > 0
            ? Math.round((stats.present / (stats.present + stats.absent)) * 100)
            : 0;
        const barColor = pct >= 75 ? '#10B981' : pct >= 50 ? '#F59E0B' : '#EF4444';

        html += `
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem;">
                    <span style="font-weight: 600;">${subject}</span>
                    <span style="color: ${barColor}; font-weight: 700;">${pct}%</span>
                </div>
                <div style="background: #E5E7EB; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div style="width: ${pct}%; height: 100%; background: ${barColor}; border-radius: 4px; transition: width 0.5s;"></div>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 2px;">${stats.sessions} session(s)</div>
            </div>
        `;
    });

    html += `</div>`;

    // Daily attendance chart
    html += `
        <h4 style="margin-bottom: 10px; color: var(--text-dark);">📅 Daily Attendance</h4>
        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px; overflow-x: auto;">
            <div style="display: flex; align-items: flex-end; gap: 4px; height: 120px; min-width: fit-content;">
    `;

    // Get days in month
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
        const stats = dailyStats[day];
        if (stats) {
            const pct = stats.present + stats.absent > 0
                ? Math.round((stats.present / (stats.present + stats.absent)) * 100)
                : 0;
            const barHeight = Math.max(pct, 5);
            const barColor = pct >= 75 ? '#10B981' : pct >= 50 ? '#F59E0B' : '#EF4444';

            html += `
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 20px;">
                    <div style="width: 16px; height: ${barHeight}px; background: ${barColor}; border-radius: 3px 3px 0 0;" title="${pct}% on day ${day}"></div>
                    <div style="font-size: 0.65rem; color: #666; margin-top: 2px;">${day}</div>
                </div>
            `;
        } else {
            html += `
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 20px;">
                    <div style="width: 16px; height: 5px; background: #E5E7EB; border-radius: 3px 3px 0 0;"></div>
                    <div style="font-size: 0.65rem; color: #ccc; margin-top: 2px;">${day}</div>
                </div>
            `;
        }
    }

    html += `</div></div>`;

    // Frequent absentees
    const sortedAbsences = Object.entries(studentAbsences)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    if (sortedAbsences.length > 0) {
        html += `
            <h4 style="margin-bottom: 10px; color: var(--text-dark);">⚠️ Top Absentees This Month</h4>
            <div style="background: #FEF3C7; border-radius: 10px; padding: 15px;">
        `;

        sortedAbsences.forEach(([key, count], idx) => {
            const [roll, ...nameParts] = key.split('-');
            const name = nameParts.join('-');
            html += `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; ${idx < sortedAbsences.length - 1 ? 'border-bottom: 1px solid #FDE68A;' : ''}">
                    <span><strong>${roll}.</strong> ${name}</span>
                    <span style="color: #D97706; font-weight: 700;">${count} absences</span>
                </div>
            `;
        });

        html += `</div>`;
    }

    // Download button
    html += `
        <button onclick="downloadMonthlyReport()" style="width: 100%; margin-top: 20px; padding: 14px; background: var(--primary-blue); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">
            📄 Download PDF Report
        </button>
    `;

    content.innerHTML = html;
}

async function downloadMonthlyReport() {
    const monthSelect = document.getElementById('report-month');
    const yearSelect = document.getElementById('report-year');
    const month = parseInt(monthSelect.value);
    const year = parseInt(yearSelect.value);
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

    showLoading('Generating Report...');
    await new Promise(r => setTimeout(r, 100));

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();

        // Title
        doc.setFont("times", "bold");
        doc.setFontSize(18);
        doc.text("MONTHLY ATTENDANCE REPORT", pageWidth / 2, 20, null, null, "center");

        doc.setFontSize(12);
        doc.setFont("times", "normal");
        doc.text(`${monthNames[month]} ${year}`, pageWidth / 2, 28, null, null, "center");

        // Get data
        const history = JSON.parse(localStorage.getItem('attendanceHistory') || '[]');
        const monthRecords = history.filter(record => {
            if (!record.date) return false;
            const d = new Date(record.date);
            return d.getMonth() === month && d.getFullYear() === year;
        });

        let totalPresent = 0, totalAbsent = 0;
        const subjectStats = {};

        monthRecords.forEach(record => {
            totalPresent += record.presentCount || 0;
            totalAbsent += record.absentCount || 0;
            const subj = record.subject || 'Unknown';
            if (!subjectStats[subj]) subjectStats[subj] = { present: 0, absent: 0, sessions: 0 };
            subjectStats[subj].sessions++;
            subjectStats[subj].present += record.presentCount || 0;
            subjectStats[subj].absent += record.absentCount || 0;
        });

        const avgPct = totalPresent + totalAbsent > 0
            ? Math.round((totalPresent / (totalPresent + totalAbsent)) * 100) : 0;

        // Summary
        doc.setFontSize(11);
        let y = 40;
        doc.text(`Total Sessions: ${monthRecords.length}`, 20, y);
        doc.text(`Total Present: ${totalPresent}`, 20, y + 7);
        doc.text(`Total Absent: ${totalAbsent}`, 20, y + 14);
        doc.text(`Average Attendance: ${avgPct}%`, 20, y + 21);

        // Subject table
        y += 35;
        doc.setFont("times", "bold");
        doc.text("Subject-wise Breakdown:", 20, y);

        const tableData = Object.entries(subjectStats).map(([subj, stats]) => {
            const pct = stats.present + stats.absent > 0
                ? Math.round((stats.present / (stats.present + stats.absent)) * 100) : 0;
            return [subj, stats.sessions, stats.present, stats.absent, pct + '%'];
        });

        doc.autoTable({
            head: [['Subject', 'Sessions', 'Present', 'Absent', 'Attendance']],
            body: tableData,
            startY: y + 5,
            theme: 'grid',
            styles: { font: 'times', fontSize: 9 },
            headStyles: { fillColor: [0, 78, 137] }
        });

        doc.save(`Monthly_Report_${monthNames[month]}_${year}.pdf`);
        hideLoading();
        showToast('Report Downloaded!');
    } catch (err) {
        hideLoading();
        console.error(err);
        showToast('Failed to generate report');
    }
}

function switchManageTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.manage-content').forEach(c => c.style.display = 'none');

    if (tab === 'students') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('students-content').style.display = 'block';
        renderManageStudents();
    } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('subjects-content').style.display = 'block';
        renderManageSubjects();
    }
}

function renderManageStudents() {
    const list = document.getElementById('manage-student-list');
    list.innerHTML = '';
    classConfig.students.forEach((s, idx) => {
        const item = document.createElement('div');
        item.className = 'manage-item';
        item.innerHTML = `
            <div>
                <div style="font-weight:700;">${s.roll}. ${s.name}</div>
                <div style="font-size:0.8rem; color:var(--text-muted);">${s.usn}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button onclick="editStudent(${idx})" title="Edit">✏️</button>
                <button onclick="deleteStudent(${idx})" title="Delete">🗑</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function addStudent() {
    const name = document.getElementById('new-s-name').value;
    const roll = document.getElementById('new-s-roll').value;
    const usn = document.getElementById('new-s-usn').value;

    if (!name || !roll) return showToast("Name and Roll required");

    classConfig.students.push({
        roll: roll,
        name: name,
        usn: usn || "Unknown"
    });
    // Auto sort by roll
    classConfig.students.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

    document.getElementById('new-s-name').value = '';
    document.getElementById('new-s-roll').value = '';
    document.getElementById('new-s-usn').value = '';
    renderManageStudents();
}

// --- Import Functions ---

function showImportHelp() {
    alert(`📥 Import Students Help

CSV Format:
Roll,Name,USN
1,John Doe,4NI22CS001
2,Jane Smith,4NI22CS002

Excel Format:
Same columns: Roll, Name, USN
First row should be headers.

Tips:
• Roll and Name are required
• USN is optional
• Duplicate rolls will be skipped
• Students will be added to existing list`);
}

function importCSV(input) {
    const file = input.files[0];
    if (!file) return;

    const status = document.getElementById('import-status');
    status.innerHTML = '⏳ Reading file...';

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(line => line.trim());

            if (lines.length < 2) {
                status.innerHTML = '❌ File is empty or has no data rows';
                return;
            }

            // Parse header to find column indices
            const header = lines[0].toLowerCase().split(',').map(h => h.trim());
            const rollIdx = header.findIndex(h => h.includes('roll') || h === 'slno' || h === 'sl' || h === 'no');
            const nameIdx = header.findIndex(h => h.includes('name'));
            const usnIdx = header.findIndex(h => h.includes('usn') || h.includes('id') || h.includes('reg'));

            if (nameIdx === -1) {
                status.innerHTML = '❌ Could not find "Name" column in CSV';
                return;
            }

            let added = 0, skipped = 0;
            const existingRolls = new Set(classConfig.students.map(s => s.roll.toString()));

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length <= Math.max(rollIdx, nameIdx)) continue;

                const roll = rollIdx >= 0 ? cols[rollIdx]?.trim() : (i).toString();
                const name = cols[nameIdx]?.trim();
                const usn = usnIdx >= 0 ? cols[usnIdx]?.trim() : '';

                if (!name) continue;

                if (existingRolls.has(roll)) {
                    skipped++;
                    continue;
                }

                classConfig.students.push({
                    roll: roll || (classConfig.students.length + 1).toString(),
                    name: name,
                    usn: usn || 'Unknown'
                });
                existingRolls.add(roll);
                added++;
            }

            classConfig.students.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));
            renderManageStudents();
            status.innerHTML = `✅ Imported ${added} students` + (skipped > 0 ? ` (${skipped} duplicates skipped)` : '');
            showToast(`Imported ${added} students`);

        } catch (err) {
            console.error(err);
            status.innerHTML = '❌ Error parsing CSV file';
        }
    };
    reader.readAsText(file);
    input.value = ''; // Reset input
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current);
    return result;
}

function importExcel(input) {
    const file = input.files[0];
    if (!file) return;

    const status = document.getElementById('import-status');
    status.innerHTML = '⏳ Reading Excel file...';

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Get first sheet
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            // Convert to JSON
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (json.length < 2) {
                status.innerHTML = '❌ Excel file is empty or has no data rows';
                return;
            }

            // Parse header
            const header = json[0].map(h => (h || '').toString().toLowerCase().trim());
            const rollIdx = header.findIndex(h => h.includes('roll') || h === 'slno' || h === 'sl' || h === 'no');
            const nameIdx = header.findIndex(h => h.includes('name'));
            const usnIdx = header.findIndex(h => h.includes('usn') || h.includes('id') || h.includes('reg'));

            if (nameIdx === -1) {
                status.innerHTML = '❌ Could not find "Name" column in Excel';
                return;
            }

            let added = 0, skipped = 0;
            const existingRolls = new Set(classConfig.students.map(s => s.roll.toString()));

            for (let i = 1; i < json.length; i++) {
                const row = json[i];
                if (!row || row.length === 0) continue;

                const roll = rollIdx >= 0 ? (row[rollIdx] || '').toString().trim() : i.toString();
                const name = (row[nameIdx] || '').toString().trim();
                const usn = usnIdx >= 0 ? (row[usnIdx] || '').toString().trim() : '';

                if (!name) continue;

                if (existingRolls.has(roll)) {
                    skipped++;
                    continue;
                }

                classConfig.students.push({
                    roll: roll || (classConfig.students.length + 1).toString(),
                    name: name,
                    usn: usn || 'Unknown'
                });
                existingRolls.add(roll);
                added++;
            }

            classConfig.students.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));
            renderManageStudents();
            status.innerHTML = `✅ Imported ${added} students` + (skipped > 0 ? ` (${skipped} duplicates skipped)` : '');
            showToast(`Imported ${added} students`);

        } catch (err) {
            console.error(err);
            status.innerHTML = '❌ Error parsing Excel file';
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = ''; // Reset input
}

function deleteStudent(index) {
    if (confirm("Remove this student?")) {
        classConfig.students.splice(index, 1);
        renderManageStudents();
    }
}

function editStudent(index) {
    const student = classConfig.students[index];
    const newName = prompt("Edit Name:", student.name);
    if (newName === null) return; // Cancelled

    const newRoll = prompt("Edit Roll Number:", student.roll);
    if (newRoll === null) return; // Cancelled

    const newUsn = prompt("Edit USN:", student.usn);
    if (newUsn === null) return; // Cancelled

    if (!newName.trim() || !newRoll.trim()) {
        showToast("Name and Roll are required");
        return;
    }

    classConfig.students[index] = {
        roll: newRoll.trim(),
        name: newName.trim(),
        usn: newUsn.trim() || "Unknown"
    };

    // Re-sort by roll number
    classConfig.students.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

    renderManageStudents();
    showToast("Student updated");
}

function renderManageSubjects() {
    const list = document.getElementById('manage-subject-list');
    list.innerHTML = '';
    classConfig.subjects.forEach((sub, idx) => {
        const item = document.createElement('div');
        item.className = 'manage-item';
        item.style.cssText = 'display: flex; align-items: center; gap: 10px;';
        item.innerHTML = `
            <input type="text" value="${sub}" 
                onchange="updateSubject(${idx}, this.value)" 
                onblur="updateSubject(${idx}, this.value)"
                style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
            <button onclick="deleteSubject(${idx})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">🗑</button>
        `;
        list.appendChild(item);
    });
}

function updateSubject(index, newName) {
    if (newName && newName.trim()) {
        classConfig.subjects[index] = newName.trim();
    }
}

function addSubject() {
    const input = document.getElementById('new-subject');
    const sub = input.value.trim();
    if (!sub) {
        showToast('Please enter a subject name');
        return;
    }
    classConfig.subjects.push(sub);
    input.value = '';
    renderManageSubjects();
    showToast('Subject added: ' + sub);
}

function deleteSubject(index) {
    if (confirm("Delete this subject?")) {
        classConfig.subjects.splice(index, 1);
        renderManageSubjects();
    }
}

function saveConfig() {
    localStorage.setItem('classConfig', JSON.stringify(classConfig));
    // Also update multi-class data
    saveCurrentClassState();
}

function saveClassConfig() {
    saveConfig();
    closeManageModal();
    showToast("Class configuration saved!");
    // Reload subject dropdown
    renderSubjectsDropdown();
    // Reinitialize student data
    initData();
}

function saveAndCloseManage() {
    saveConfig();
    location.reload();
}

initData();
initDates();

// ==========================================
// PWA - Progressive Web App Support
// ==========================================

let deferredPrompt = null;

// Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then((registration) => {
                console.log('[PWA] Service Worker registered successfully:', registration.scope);

                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New content available
                            showUpdateToast();
                        }
                    });
                });
            })
            .catch((error) => {
                console.error('[PWA] Service Worker registration failed:', error);
            });

        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'SW_UPDATED') {
                showToast(`Update available (${event.data.version}). Refresh to apply.`);
            }
        });
    });
}

// Handle beforeinstallprompt event
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome's mini-infobar
    e.preventDefault();
    // Store the event for later use
    deferredPrompt = e;
    // Show install button
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
        installBtn.style.display = 'flex';
    }
    console.log('[PWA] Install prompt ready');
});

// Handle app installed event
window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredPrompt = null;
    // Hide install button
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
        installBtn.style.display = 'none';
    }
    showToast('🎉 App installed successfully!');
});

// Install PWA function
// Install PWA function
function installPWA() {
    // Check for iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (isIOS) {
        alert('To install on iOS:\n\n1. Tap the Share button (square with arrow)\n2. Scroll down and tap "Add to Home Screen"');
        return;
    }

    if (!deferredPrompt) {
        showToast('App is already installed/running as PWA');
        return;
    }

    // Show the install prompt
    deferredPrompt.prompt();

    // Wait for the user's response
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('[PWA] User accepted the install prompt');
        } else {
            console.log('[PWA] User dismissed the install prompt');
        }
        deferredPrompt = null;
    });
}

// Show update toast with refresh option
function showUpdateToast() {
    const toast = document.createElement('div');
    toast.className = 'toast update-toast';
    toast.innerHTML = `
        <span>🔄 New version available!</span>
        <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: white; color: #004E89; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            Refresh
        </button>
    `;
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-blue);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        z-index: 9999;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    document.body.appendChild(toast);

    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 10000);
}

// Check if running as PWA/standalone
function isPWA() {
    return window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true ||
        document.referrer.includes('android-app://');
}

// Log PWA status
if (isPWA()) {
    console.log('[PWA] Running in standalone mode');
} else {
    console.log('[PWA] Running in browser mode');
}

// Initialize the app on page load
// Initialize the app on page load
initApp();

// Force install button on iOS if not PWA
if (!isPWA() && /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
        installBtn.style.display = 'flex';
    }
}
